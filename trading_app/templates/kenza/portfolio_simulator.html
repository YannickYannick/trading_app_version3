<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur de Portefeuille - Kenza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .simulator-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }
        .input-group-custom {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
        }
        .result-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .btn-simulate {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            border-radius: 50px;
            padding: 15px 40px;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        .btn-simulate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.3);
        }
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #007bff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- En-tête -->
                <div class="text-center mb-4">
                    <h1 class="text-white display-4">
                        <i class="fas fa-chart-line"></i> Simulateur de Portefeuille
                    </h1>
                    <p class="text-white-50 lead">Comparez l'investissement immobilier vs actions sur 5 ans</p>
                </div>

                <!-- Paramètres de simulation -->
                <div class="simulator-card p-4">
                    <h3 class="mb-4">
                        <i class="fas fa-cog"></i> Paramètres de Simulation
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group-custom">
                                <label class="form-label fw-bold">Capital Initial (€)</label>
                                <input type="number" id="capitalInitial" class="form-control" value="30000" min="1000" step="1000">
                                <small class="text-muted">Montant de départ pour l'investissement</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group-custom">
                                <label class="form-label fw-bold">Durée (années)</label>
                                <input type="number" id="dureeAnnees" class="form-control" value="5" min="1" max="20">
                                <small class="text-muted">Période de simulation</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group-custom">
                                <label class="form-label fw-bold">Loyer Mensuel (€)</label>
                                <input type="number" id="loyerMensuel" class="form-control" value="700" min="100" step="50">
                                <small class="text-muted">Loyer à payer pendant la simulation</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group-custom">
                                <label class="form-label fw-bold">Ticker Actions</label>
                                <input type="text" id="tickerActions" class="form-control" value="AAPL" placeholder="AAPL, MSFT, GOOGL...">
                                <small class="text-muted">Symbole boursier à analyser</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group-custom">
                                <label class="form-label fw-bold">Objectif Immobilier (€)</label>
                                <input type="number" id="objectifImmobilier" class="form-control" value="180000" min="50000" step="10000">
                                <small class="text-muted">Valeur cible du bien immobilier</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group-custom">
                                <label class="form-label fw-bold">Travaux Année 1 (€)</label>
                                <input type="number" id="travauxAnnee1" class="form-control" value="20000" min="0" step="1000">
                                <small class="text-muted">Coût des travaux la première année</small>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-simulate" onclick="lancerSimulation()">
                            <i class="fas fa-play me-2"></i>Lancer la Simulation
                        </button>
                    </div>
                </div>

                <!-- Résultats de simulation -->
                <div id="resultatsSimulation" style="display: none;">
                    <!-- Résumé des résultats -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="result-card">
                                <h4><i class="fas fa-home"></i> Immobilier</h4>
                                <div class="metric-value" id="resultatImmobilier">-</div>
                                <div class="metric-label">Capital Final</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="result-card">
                                <h4><i class="fas fa-chart-line"></i> Actions</h4>
                                <div class="metric-value" id="resultatActions">-</div>
                                <div class="metric-label">Capital Final</div>
                            </div>
                        </div>
                    </div>

                    <!-- Graphique principal et performance combinés -->
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0"><i class="fas fa-chart-area"></i> Évolution des Capitaux & Performance</h4>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="resetZoom()">
                                    <i class="fas fa-search-minus"></i> Reset Zoom
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="toggleLogScale()">
                                    <i class="fas fa-chart-line"></i> Échelle Log
                                </button>
                                <div class="form-check form-switch ms-3">
                                    <input class="form-check-input" type="checkbox" id="switchMode" onchange="toggleChartMode()">
                                    <label class="form-check-label" for="switchMode">
                                        <i class="fas fa-exchange-alt"></i> Mode Performance
                                    </label>
                                </div>
                            </div>
                        </div>
                        <canvas id="chartPrincipal" height="100"></canvas>
                    </div>

                    <!-- Métriques détaillées -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5><i class="fas fa-calculator"></i> Coûts Immobilier</h5>
                                <div class="metric-value" id="coutImmobilier">-</div>
                                <div class="metric-label">Coût total sur la période</div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <div>Frais notaire: <span id="fraisNotaire">-</span></div>
                                        <div>Travaux: <span id="travauxTotal">-</span></div>
                                        <div>Apports mensuels: <span id="apportsMensuels">-</span></div>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5><i class="fas fa-chart-pie"></i> Performance Actions</h5>
                                <div class="metric-value" id="performanceActions">-</div>
                                <div class="metric-label">Performance relative</div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <div>Prix initial: <span id="prixInitial">-</span></div>
                                        <div>Actions achetées: <span id="actionsAchetees">-</span></div>
                                        <div>Loyers payés: <span id="loyersPayes">-</span></div>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Recommandation -->
                    <div class="metric-card text-center">
                        <h4><i class="fas fa-lightbulb"></i> Recommandation</h4>
                        <div class="metric-value" id="recommandation">-</div>
                        <div class="metric-label">Basé sur la simulation</div>
                    </div>

                    <!-- Graphique de performance de l'action étudiée (dépliable) -->
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0"><i class="fas fa-chart-bar"></i> Performance de l'Action Étudiée</h4>
                            <div class="d-flex align-items-center">
                                <div class="form-check form-switch me-3">
                                    <input class="form-check-input" type="checkbox" id="switchActionMode" onchange="toggleActionMode()">
                                    <label class="form-check-label" for="switchActionMode">
                                        <i class="fas fa-chart-line"></i> Valeur Titre
                                    </label>
                                </div>
                                <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#actionPerformanceCollapse" onclick="toggleActionGraph()">
                                    <i class="fas fa-chevron-down"></i> Afficher/Masquer
                                </button>
                            </div>
                        </div>
                        <div class="collapse" id="actionPerformanceCollapse">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Ce graphique montre la performance de l'action étudiée sur la période sélectionnée
                            </div>
                            <canvas id="chartActionPerformance" height="100"></canvas>
                        </div>
                    </div>

                    <!-- Graphique du coût de l'emprunt -->
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0"><i class="fas fa-money-bill-wave"></i> Coût de l'Emprunt</h4>
                            <div class="d-flex align-items-center">
                                <div class="form-check form-switch me-3">
                                    <input class="form-check-input" type="checkbox" id="switchEmpruntMode" onchange="toggleEmpruntMode()">
                                    <label class="form-check-label" for="switchEmpruntMode">
                                        <i class="fas fa-chart-area"></i> Mode Cumulé
                                    </label>
                                </div>
                                <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#empruntCollapse" onclick="toggleEmpruntGraph()">
                                    <i class="fas fa-chevron-down"></i> Afficher/Masquer
                                </button>
                            </div>
                        </div>
                        <div class="collapse" id="empruntCollapse">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> Ce graphique détaille les coûts de l'emprunt immobilier
                            </div>
                            <canvas id="chartEmprunt" height="100"></canvas>
                        </div>
                    </div>

                    <!-- Section des méthodes de calcul -->
                    <div class="mt-5">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h4 class="mb-0"><i class="fas fa-calculator"></i> Méthodes de Calcul Utilisées</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-home"></i> Calcul Immobilier</h5>
                                        <ul class="list-unstyled">
                                            <li><strong>Capital initial :</strong> Montant de départ pour l'investissement</li>
                                            <li><strong>Apport mensuel :</strong> Calculé pour atteindre l'objectif immobilier</li>
                                            <li><strong>Frais de notaire :</strong> 8% du prix d'achat</li>
                                            <li><strong>Travaux année 1 :</strong> Dépenses de rénovation initiales</li>
                                            <li><strong>Intérêts emprunt :</strong> 3% annuel sur le capital restant</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-chart-line"></i> Calcul Actions</h5>
                                        <ul class="list-unstyled">
                                            <li><strong>Rendement mensuel :</strong> Adaptatif selon la durée (7.5% à 10% annuel)</li>
                                            <li><strong>Volatilité :</strong> Réduite avec la durée (2% à 3% mensuel)</li>
                                            <li><strong>Protection :</strong> Plancher à 5% du capital initial</li>
                                            <li><strong>Rebond :</strong> +5% après 3 pertes consécutives</li>
                                            <li><strong>Loyer :</strong> Déduit mensuellement du portefeuille</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h5><i class="fas fa-info-circle"></i> Formules Mathématiques</h5>
                                        <div class="alert alert-light">
                                            <strong>Distribution normale :</strong> Box-Muller transform pour la simulation aléatoire<br>
                                            <strong>Performance relative :</strong> ((Valeur actuelle / Valeur initiale) - 1) × 100<br>
                                            <strong>Coût total immobilier :</strong> Prix d'achat + Frais + Travaux + Loyers - Apports<br>
                                            <strong>Profit net :</strong> Valeur finale - Capital initial - Coûts totaux
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chargement -->
                <div id="chargement" style="display: none;" class="text-center py-5">
                    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="text-white mt-3">Simulation en cours...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chartPrincipal, chartActionPerformance, chartEmprunt;
        let isLogScale = false;
        let originalData = null;

        function lancerSimulation() {
            console.log('🚀 Lancement de la simulation...');
            
            try {
                // Afficher le chargement
                document.getElementById('chargement').style.display = 'block';
                document.getElementById('resultatsSimulation').style.display = 'none';

                // Récupérer les paramètres
                const params = {
                    capitalInitial: parseFloat(document.getElementById('capitalInitial').value),
                    dureeAnnees: parseInt(document.getElementById('dureeAnnees').value),
                    loyerMensuel: parseFloat(document.getElementById('loyerMensuel').value),
                    tickerActions: document.getElementById('tickerActions').value,
                    objectifImmobilier: parseFloat(document.getElementById('objectifImmobilier').value),
                    travauxAnnee1: parseFloat(document.getElementById('travauxAnnee1').value)
                };

                console.log('📊 Paramètres récupérés:', params);

                // Simuler après un délai pour montrer le chargement
                setTimeout(() => {
                    console.log('⏰ Délai écoulé, lancement de executerSimulation...');
                    executerSimulation(params);
                }, 1000);
                
            } catch (error) {
                console.error('❌ Erreur dans lancerSimulation:', error);
                // Masquer le chargement et afficher l'erreur
                document.getElementById('chargement').style.display = 'none';
                alert('Erreur lors du lancement: ' + error.message);
            }
        }

        function executerSimulation(params) {
            console.log('🔄 Début de executerSimulation avec params:', params);
            
            // Initialiser originalData comme un objet vide
            originalData = {};
            
            try {
                const mois = params.dureeAnnees * 12;
                const loyerMensuel = params.loyerMensuel;
                const capitalInitial = params.capitalInitial;
                
                console.log('📅 Calculs initiaux:', { mois, loyerMensuel, capitalInitial });

            // ===========================================
            // SCENARIO IMMOBILIER
            // ===========================================
            const tauxFraisNotaire = 0.08;
            const fraisNotaire = params.objectifImmobilier * tauxFraisNotaire;
            const objectifNet = params.objectifImmobilier - (loyerMensuel * mois) - params.travauxAnnee1 - fraisNotaire;
            const ajoutLineaireCible = loyerMensuel + (objectifNet - capitalInitial) / mois;

            // Simulation immobilier
            const capitalImmobilier = [capitalInitial];
            let resteEmprunt = params.objectifImmobilier - capitalInitial;
            const interetsMensuels = [0]; // Pour le graphique des coûts d'emprunt
            const capitalRestant = [resteEmprunt]; // Pour tracer l'évolution du capital restant

            // Calculer le remboursement mensuel de l'emprunt (formule d'amortissement classique)
            const tauxMensuel = 0.03 / 12; // 3% annuel / 12 mois
            const remboursementMensuelEmprunt = (resteEmprunt * tauxMensuel * Math.pow(1 + tauxMensuel, mois)) / (Math.pow(1 + tauxMensuel, mois) - 1);

            console.log('💰 Remboursement mensuel emprunt:', formatCurrency(remboursementMensuelEmprunt));

            for (let m = 1; m <= mois; m++) {
                const interetMensuel = resteEmprunt * tauxMensuel;
                const remboursementCapitalEmprunt = remboursementMensuelEmprunt - interetMensuel;
                
                // L'épargne mensuelle est séparée du remboursement de l'emprunt
                const epargneMensuelle = ajoutLineaireCible - loyerMensuel;
                let nouveauCapital = capitalImmobilier[m-1] + epargneMensuelle;
                
                if (m === 12) {
                    nouveauCapital -= params.travauxAnnee1;
                }
                
                // Mettre à jour le capital restant (diminue avec le remboursement)
                resteEmprunt = Math.max(resteEmprunt - remboursementCapitalEmprunt, 0);
                
                capitalImmobilier.push(nouveauCapital);
                interetsMensuels.push(interetMensuel);
                capitalRestant.push(resteEmprunt);
            }

            // ===========================================
            // SCENARIO ACTIONS (données réelles)
            // ===========================================
            const portfolioValueActions = [capitalInitial];
            
            // Récupérer les données historiques du ticker
            console.log('📊 Récupération des données réelles pour:', params.tickerActions);
            
            // Déclarer la variable au niveau de la fonction
            let historicalData = null;
            
            try {
                // Récupérer les données historiques du ticker
                historicalData = getHistoricalDataSync(params.tickerActions, params.dureeAnnees);
                
                if (historicalData && historicalData.length > 0) {
                    console.log('✅ Données historiques récupérées:', historicalData.length, 'points');
                    
                    // Utiliser les vraies données historiques
                    let currentValue = capitalInitial;
                    
                    for (let m = 1; m <= mois; m++) {
                        if (m < historicalData.length) {
                            // Calculer le rendement mensuel basé sur les vraies données
                            const currentPrice = historicalData[m].price;
                            const previousPrice = historicalData[m-1].price;
                            const monthlyReturn = (currentPrice - previousPrice) / previousPrice;
                            
                            currentValue = currentValue * (1 + monthlyReturn) - loyerMensuel;
                        } else {
                            // Si pas assez de données historiques, utiliser une extrapolation
                            const avgReturn = calculateAverageReturn(historicalData);
                            currentValue = currentValue * (1 + avgReturn) - loyerMensuel;
                        }
                        
                        // Protection contre les valeurs négatives
                        currentValue = Math.max(currentValue, capitalInitial * 0.05);
                        portfolioValueActions.push(currentValue);
                    }
                    
                } else {
                    console.log('⚠️ Pas de données historiques, utilisation de la simulation');
                    // Fallback vers la simulation si pas de données
                    portfolioValueActions.push(...simulateActions(capitalInitial, loyerMensuel, mois));
                }
                
            } catch (error) {
                console.error('❌ Erreur lors de la récupération des données:', error);
                console.log('⚠️ Utilisation de la simulation de fallback');
                // Fallback vers la simulation en cas d'erreur
                portfolioValueActions.push(...simulateActions(capitalInitial, loyerMensuel, mois));
            }
            
            // Stocker les données historiques pour les autres graphiques
            if (historicalData && historicalData.length > 0) {
                originalData.historicalData = historicalData;
                console.log('💾 Données historiques stockées dans originalData');
            }

            // ===========================================
            // CALCULS FINAUX
            // ===========================================
            const capitalFinalImmobilier = capitalImmobilier[mois];
            const capitalFinalActions = portfolioValueActions[mois];

            const coutTotalImmobilier = capitalInitial + (ajoutLineaireCible - loyerMensuel) * mois + params.travauxAnnee1;
            const coutTotalActions = capitalInitial + loyerMensuel * mois;

            const profitImmobilier = capitalFinalImmobilier - coutTotalImmobilier;
            const profitActions = capitalFinalActions - capitalInitial - loyerMensuel * mois;

            // Sauvegarder les données originales pour les contrôles
            originalData = {
                capitalImmobilier,
                portfolioValueActions,
                interetsMensuels,
                capitalRestant,
                capitalInitial: params.capitalInitial, // Ajout du capital initial
                capitalFinalImmobilier,
                capitalFinalActions,
                fraisNotaire,
                travauxTotal: params.travauxAnnee1,
                apportsMensuels: (ajoutLineaireCible - loyerMensuel) * mois,
                loyersPayes: loyerMensuel * mois,
                coutTotalImmobilier,
                profitImmobilier,
                profitActions,
                mois,
                // Préserver les données historiques si elles existent
                ...(originalData.historicalData && { historicalData: originalData.historicalData })
            };

            // ===========================================
            // AFFICHAGE DES RÉSULTATS
            // ===========================================
            afficherResultats(originalData);

            // Masquer le chargement
            document.getElementById('chargement').style.display = 'none';
            document.getElementById('resultatsSimulation').style.display = 'block';
            
            console.log('✅ Simulation terminée avec succès');
            
            } catch (error) {
                console.error('❌ Erreur dans executerSimulation:', error);
                // Masquer le chargement et afficher l'erreur
                document.getElementById('chargement').style.display = 'none';
                alert('Erreur lors de la simulation: ' + error.message);
            }
        }

        function afficherResultats(resultats) {
            console.log('📊 Début de afficherResultats avec:', resultats);
            
            try {
                // Mettre à jour les métriques principales
                document.getElementById('resultatImmobilier').textContent = formatCurrency(resultats.capitalFinalImmobilier);
                document.getElementById('resultatActions').textContent = formatCurrency(resultats.capitalFinalActions);

            // Mettre à jour les coûts
            document.getElementById('coutImmobilier').textContent = formatCurrency(resultats.coutTotalImmobilier);
            document.getElementById('fraisNotaire').textContent = formatCurrency(resultats.fraisNotaire);
            document.getElementById('travauxTotal').textContent = formatCurrency(resultats.travauxTotal);
            document.getElementById('apportsMensuels').textContent = formatCurrency(resultats.apportsMensuels);

            // Mettre à jour les performances
            console.log('🔍 Calcul performanceActions:', {
                capitalFinalActions: resultats.capitalFinalActions,
                capitalInitial: resultats.capitalInitial,
                calcul: `((${resultats.capitalFinalActions} - ${resultats.capitalInitial}) / ${resultats.capitalInitial}) * 100`
            });
            
            const performanceActions = ((resultats.capitalFinalActions - resultats.capitalInitial) / resultats.capitalInitial) * 100;
            console.log('🔍 Performance calculée:', performanceActions);
            
            document.getElementById('performanceActions').textContent = performanceActions.toFixed(1) + '%';
            document.getElementById('loyersPayes').textContent = formatCurrency(resultats.loyersPayes);
            
            // Mettre à jour les informations sur les actions
            document.getElementById('prixInitial').textContent = formatCurrency(resultats.capitalInitial);
            document.getElementById('actionsAchetees').textContent = '1'; // Simplifié pour l'instant

            // Recommandation
            let recommandation = '';
            if (resultats.profitImmobilier > resultats.profitActions) {
                const difference = resultats.profitImmobilier - resultats.profitActions;
                recommandation = `🏠 Immobilier +${formatCurrency(difference)}`;
            } else {
                const difference = resultats.profitActions - resultats.profitImmobilier;
                recommandation = `📈 Actions +${formatCurrency(difference)}`;
            }
            document.getElementById('recommandation').textContent = recommandation;

            // S'assurer que la section des résultats est visible avant de créer le graphique
            document.getElementById('resultatsSimulation').style.display = 'block';
            
            console.log('🔍 Section resultatsSimulation affichée');
            console.log('🔍 Canvas chartPrincipal existe?', !!document.getElementById('chartPrincipal'));
            console.log('🔍 Tous les canvas:', document.querySelectorAll('canvas'));
            
            // Attendre un peu que le DOM soit mis à jour
            setTimeout(() => {
                console.log('⏰ Délai écoulé, création du graphique...');
                console.log('🔍 Canvas chartPrincipal existe maintenant?', !!document.getElementById('chartPrincipal'));
                
                // Créer seulement le graphique principal (toujours visible)
                creerGraphiques(resultats);
                
                // Les autres graphiques seront créés à la demande quand les sections sont dépliées
            }, 100);
            
            console.log('✅ afficherResultats terminé avec succès');
            
            } catch (error) {
                console.error('❌ Erreur dans afficherResultats:', error);
                alert('Erreur lors de l\'affichage des résultats: ' + error.message);
            }
        }

        function creerGraphiques(resultats) {
            console.log('🎨 Début de creerGraphiques avec:', resultats);
            
            try {
                const moisRange = Array.from({length: resultats.mois + 1}, (_, i) => i);

                // Calcul de l'échelle adaptative pour le mode Capital
                const allValues = [...resultats.capitalImmobilier, ...resultats.portfolioValueActions];
                const minValue = Math.min(...allValues);
                const maxValue = Math.max(...allValues);
                const padding = Math.max((maxValue - minValue) * 0.1, 1000); // Minimum 1000€ de padding

                console.log('📏 Échelle Capital calculée:', { minValue, maxValue, padding });

                // Vérifier que l'élément existe
                const chartElement = document.getElementById('chartPrincipal');
                if (!chartElement) {
                    console.error('❌ Élément chartPrincipal non trouvé');
                    console.log('🔍 Éléments disponibles:', document.querySelectorAll('canvas'));
                    console.log('🔍 Section resultatsSimulation:', document.getElementById('resultatsSimulation'));
                    return;
                }
                
                console.log('✅ Élément chartPrincipal trouvé');
                console.log('🔍 Élément visible:', chartElement.offsetParent !== null);
                console.log('🔍 Dimensions:', chartElement.offsetWidth, 'x', chartElement.offsetHeight);

            // Graphique principal
            const ctxPrincipal = chartElement.getContext('2d');
            if (chartPrincipal) chartPrincipal.destroy();
            
            chartPrincipal = new Chart(ctxPrincipal, {
                type: 'line',
                data: {
                    labels: moisRange,
                    datasets: [{
                        label: '🏠 Immobilier',
                        data: resultats.capitalImmobilier,
                        borderColor: '#FF6B35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1
                    }, {
                        label: '📈 Actions',
                        data: resultats.portfolioValueActions,
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Évolution des Capitaux'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy'
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: minValue - padding, // Permet les valeurs négatives
                            max: maxValue + padding,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                maxTicksLimit: 20 // Limiter le nombre de ticks pour la lisibilité
                            }
                        }
                    }
                }
            });
            
            console.log('✅ Graphique principal créé avec succès');
            
            } catch (error) {
                console.error('❌ Erreur dans creerGraphiques:', error);
                alert('Erreur lors de la création du graphique: ' + error.message);
            }
        }

        // Graphique de performance de l'action étudiée
        function creerGraphiqueActionPerformance(resultats) {
            console.log('🎯 Création du graphique Action Performance');
            console.log('🔍 originalData:', originalData);
            
            if (!originalData || !originalData.historicalData) {
                console.log('⚠️ Pas de données historiques disponibles, utilisation de la simulation');
                // Fallback vers la simulation si pas de données historiques
                createSimulatedActionData(resultats);
                return;
            }
            
            const moisRange = Array.from({length: resultats.mois + 1}, (_, i) => i);
            
            // Utiliser les vraies données historiques du ticker
            const historicalData = originalData.historicalData;
            console.log('📊 Données historiques utilisées:', historicalData.length, 'points');
            
            // Calculer la performance et la valeur basées sur les vraies données
            const actionPerformance = [0]; // Performance relative en %
            const actionValeur = [100]; // Valeur de départ à 100€
            
            for (let m = 1; m <= Math.min(moisRange.length, historicalData.length); m++) {
                if (m < historicalData.length) {
                    // Calculer le rendement mensuel basé sur les vraies données
                    const currentPrice = historicalData[m].price;
                    const previousPrice = historicalData[m-1].price;
                    const monthlyReturn = (currentPrice - previousPrice) / previousPrice;
                    
                    // Performance cumulative en %
                    const previousPerformance = actionPerformance[m-1];
                    actionPerformance.push(previousPerformance + (monthlyReturn * 100));
                    
                    // Valeur du titre
                    const previousValeur = actionValeur[m-1];
                    actionValeur.push(previousValeur * (1 + monthlyReturn));
                } else {
                    // Si pas assez de données historiques, extrapoler
                    const avgReturn = calculateAverageReturn(historicalData);
                    const previousPerformance = actionPerformance[m-1];
                    actionPerformance.push(previousPerformance + (avgReturn * 100));
                    
                    const previousValeur = actionValeur[m-1];
                    actionValeur.push(previousValeur * (1 + avgReturn));
                }
            }
            
            // Sauvegarder les deux séries de données
            originalData.actionPerformance = actionPerformance;
            originalData.actionValeur = actionValeur;
            
            console.log('✅ Données action calculées:', {
                performance: actionPerformance.length,
                valeur: actionValeur.length
            });
            
            // Créer le graphique avec les données calculées
            createActionPerformanceChart(resultats);
                }
        
        // Fonction pour créer le graphique une fois les données prêtes
        function createActionPerformanceChart(resultats) {
            console.log('🎨 Création du graphique Action Performance');
            
            const moisRange = Array.from({length: resultats.mois + 1}, (_, i) => i);
            
            // Vérifier que l'élément existe
            const chartElement = document.getElementById('chartActionPerformance');
            if (!chartElement) {
                console.error('❌ Élément chartActionPerformance non trouvé');
                return;
            }
            
            const ctxAction = chartElement.getContext('2d');
            if (chartActionPerformance) chartActionPerformance.destroy();
            
            chartActionPerformance = new Chart(ctxAction, {
                type: 'line',
                data: {
                    labels: moisRange,
                    datasets: [{
                        label: '📊 Performance Action Étudiée (%)',
                        data: originalData.actionPerformance.map(val => (val * 100).toFixed(1)),
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance de l\'Action Étudiée'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
            
            console.log('✅ Graphique Action Performance créé avec succès');
        }
        
        // Fonction de fallback pour créer des données simulées si pas de données historiques
        function createSimulatedActionData(resultats) {
            console.log('🔄 Création de données simulées pour l\'action');
            
            const moisRange = Array.from({length: resultats.mois + 1}, (_, i) => i);
            
            // Simuler la performance de l'action étudiée
            const actionPerformance = [0];
            const actionValeur = [100]; // Valeur de départ à 100€
            const monthlyReturn = 0.01; // 1% mensuel en moyenne
            const volatility = 0.05; // 5% de volatilité mensuelle
            
            for (let m = 1; m <= moisRange.length; m++) {
                const change = normalRandom(monthlyReturn, volatility);
                const previousValue = actionPerformance[m-1];
                actionPerformance.push(previousValue + change);
                
                // Calculer la valeur du titre
                const previousValeur = actionValeur[m-1];
                actionValeur.push(previousValeur * (1 + change));
            }
            
            // Sauvegarder les deux séries de données
            originalData.actionPerformance = actionPerformance;
            originalData.actionValeur = actionValeur;
            
            console.log('✅ Données simulées créées:', {
                performance: actionPerformance.length,
                valeur: actionValeur.length
            });
            
            // Créer le graphique avec les données simulées
            createActionPerformanceChart(resultats);
        }
        
        // Bascule entre performance et valeur du titre pour l'action
        function toggleActionMode() {
            if (!originalData || !originalData.actionPerformance || !originalData.actionValeur) return;
            
            const isValeurMode = document.getElementById('switchActionMode').checked;
            
            if (chartActionPerformance) {
                if (isValeurMode) {
                    // Mode Valeur du Titre
                    chartActionPerformance.data.datasets[0].data = originalData.actionValeur;
                    chartActionPerformance.data.datasets[0].label = '📊 Valeur Action Étudiée (€)';
                    chartActionPerformance.options.scales.y.ticks.callback = function(value) {
                        return formatCurrency(value);
                    };
                    chartActionPerformance.options.plugins.title.text = 'Valeur de l\'Action Étudiée';
                } else {
                    // Mode Performance
                    chartActionPerformance.data.datasets[0].data = originalData.actionPerformance.map(val => (val * 100).toFixed(1));
                    chartActionPerformance.data.datasets[0].label = '📊 Performance Action Étudiée (%)';
                    chartActionPerformance.options.scales.y.ticks.callback = function(value) {
                        return value.toFixed(1) + '%';
                    };
                    chartActionPerformance.options.plugins.title.text = 'Performance de l\'Action Étudiée';
                }
                
                chartActionPerformance.update();
            }
        }

        // Graphique du coût de l'emprunt
        function creerGraphiqueEmprunt(resultats) {
            const moisRange = Array.from({length: resultats.mois + 1}, (_, i) => i);
            
            // Calculer les intérêts cumulés
            const interetsCumules = [];
            let cumul = 0;
            for (let i = 0; i < resultats.interetsMensuels.length; i++) {
                cumul += resultats.interetsMensuels[i];
                interetsCumules.push(cumul);
            }
            
            // Sauvegarder les deux séries de données
            originalData.interetsCumules = interetsCumules;
            
            // Vérifier que l'élément existe
            const chartElement = document.getElementById('chartEmprunt');
            if (!chartElement) {
                console.error('Élément chartEmprunt non trouvé');
                return;
            }
            
            const ctxEmprunt = chartElement.getContext('2d');
            if (chartEmprunt) chartEmprunt.destroy();
            
            chartEmprunt = new Chart(ctxEmprunt, {
                type: 'bar',
                data: {
                    labels: moisRange,
                    datasets: [{
                        label: '💰 Intérêts Mensuels',
                        data: resultats.interetsMensuels,
                        backgroundColor: 'rgba(255, 193, 7, 0.8)',
                        borderColor: '#FFC107',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Coût de l\'Emprunt Immobilier'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Intérêts: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Bascule entre mode mensuel et cumulé pour l'emprunt
        function toggleEmpruntMode() {
            if (!originalData || !originalData.interetsCumules) return;
            
            const isCumuleMode = document.getElementById('switchEmpruntMode').checked;
            
            if (chartEmprunt) {
                if (isCumuleMode) {
                    // Mode Cumulé
                    chartEmprunt.data.datasets[0].data = originalData.interetsCumules;
                    chartEmprunt.data.datasets[0].label = '💰 Intérêts Cumulés';
                    chartEmprunt.options.plugins.title.text = 'Coût Total de l\'Emprunt (Cumulé)';
                    chartEmprunt.options.scales.y.ticks.callback = function(value) {
                        return formatCurrency(value);
                    };
                } else {
                    // Mode Mensuel
                    chartEmprunt.data.datasets[0].data = originalData.interetsMensuels;
                    chartEmprunt.data.datasets[0].label = '💰 Intérêts Mensuels';
                    chartEmprunt.options.plugins.title.text = 'Coût de l\'Emprunt Immobilier';

                    chartEmprunt.options.scales.y.ticks.callback = function(value) {
                        return formatCurrency(value);
                    };
                }
                
                chartEmprunt.update();
            }
        }

        // Fonction pour afficher/masquer le graphique de l'action
        function toggleActionGraph() {
            console.log('🎯 toggleActionGraph appelé');
            console.log('🔍 originalData existe?', !!originalData);
            console.log('🔍 originalData.historicalData?', originalData?.historicalData);
            
            if (!originalData) {
                console.log('❌ Pas de données originales');
                return;
            }
            
            // Attendre que l'animation de collapse soit terminée
            setTimeout(() => {
                const isVisible = !document.getElementById('actionPerformanceCollapse').classList.contains('collapse');
                console.log('🔍 Section visible?', isVisible);
                console.log('🔍 chartActionPerformance existe?', !!chartActionPerformance);
                
                if (isVisible && !chartActionPerformance) {
                    console.log('🎨 Création du graphique Action Performance...');
                    creerGraphiqueActionPerformance(originalData);
                } else {
                    console.log('ℹ️ Graphique déjà créé ou section masquée');
                }
            }, 300);
        }

        // Fonction pour afficher/masquer le graphique de l'emprunt
        function toggleEmpruntGraph() {
            console.log('💰 toggleEmpruntGraph appelé');
            console.log('🔍 originalData existe?', !!originalData);
            
            if (!originalData) {
                console.log('❌ Pas de données originales');
                return;
            }
            
            // Attendre que l'animation de collapse soit terminée
            setTimeout(() => {
                const isVisible = !document.getElementById('empruntCollapse').classList.contains('collapse');
                console.log('🔍 Section visible?', isVisible);
                console.log('🔍 chartEmprunt existe?', !!chartEmprunt);
                
                if (isVisible && !chartEmprunt) {
                    console.log('🎨 Création du graphique Emprunt...');
                    creerGraphiqueEmprunt(originalData);
                } else {
                    console.log('ℹ️ Graphique déjà créé ou section masquée');
                }
            }, 300);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function normalRandom(mean, std) {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return mean + std * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        // Fonctions de contrôle des graphiques
        function resetZoom() {
            if (chartPrincipal) {
                chartPrincipal.resetZoom();
            }
            if (chartActionPerformance) {
                chartActionPerformance.resetZoom();
            }
            if (chartEmprunt) {
                chartEmprunt.resetZoom();
            }
        }

        function toggleLogScale() {
            if (!originalData) return;
            
            isLogScale = !isLogScale;
            
            if (chartPrincipal) {
                const yAxis = chartPrincipal.options.scales.y;
                if (isLogScale) {
                    yAxis.type = 'logarithmic';
                    yAxis.min = undefined;
                    yAxis.max = undefined;
                } else {
                    yAxis.type = 'linear';
                    // Restaurer l'échelle adaptative
                    const allValues = [...originalData.capitalImmobilier, ...originalData.portfolioValueActions];
                    const minValue = Math.min(...allValues);
                    const maxValue = Math.max(...allValues);
                    const padding = Math.max((maxValue - minValue) * 0.1, 1000);
                    yAxis.min = minValue - padding;
                    yAxis.max = maxValue + padding;
                }
                chartPrincipal.update();
            }
        }

        // Bascule entre mode Capital et Performance pour le graphique principal
        function toggleChartMode() {
            console.log('🔄 toggleChartMode appelé');
            console.log('🔍 originalData existe?', !!originalData);
            console.log('🔍 chartPrincipal existe?', !!chartPrincipal);
            
            if (!originalData) {
                console.log('❌ Pas de données originales');
                return;
            }
            
            const isPerformanceMode = document.getElementById('switchMode').checked;
            console.log('🔍 Mode Performance activé?', isPerformanceMode);
            
            if (chartPrincipal) {
                if (isPerformanceMode) {
                    // Mode Performance
                    const performanceImmobilier = originalData.capitalImmobilier.map(val => (val/originalData.capitalImmobilier[0] - 1) * 100);
                    const performanceActions = originalData.portfolioValueActions.map(val => (val/originalData.portfolioValueActions[0] - 1) * 100);
                    
                    chartPrincipal.data.datasets[0].data = performanceImmobilier;
                    chartPrincipal.data.datasets[0].label = '🏠 Performance Immobilier (%)';
                    chartPrincipal.data.datasets[1].data = performanceActions;
                    chartPrincipal.data.datasets[1].label = '📈 Performance Actions (%)';
                    
                    chartPrincipal.options.scales.y.ticks.callback = function(value) {
                        return value.toFixed(1) + '%';
                    };
                    
                    chartPrincipal.options.plugins.title.text = 'Performance Relative (%)';
                    
                    // ADAPTER L'ÉCHELLE pour le mode Performance
                    const allPerformanceValues = [...performanceImmobilier, ...performanceActions];
                    const minPerf = Math.min(...allPerformanceValues);
                    const maxPerf = Math.max(...allPerformanceValues);
                    const paddingPerf = Math.max((maxPerf - minPerf) * 0.1, 5); // Minimum 5% de padding
                    
                    chartPrincipal.options.scales.y.min = minPerf - paddingPerf;
                    chartPrincipal.options.scales.y.max = maxPerf + paddingPerf;
                    
                    console.log('📏 Échelle Performance adaptée:', { minPerf, maxPerf, paddingPerf });
                    
                } else {
                    // Mode Capital
                    chartPrincipal.data.datasets[0].data = originalData.capitalImmobilier;
                    chartPrincipal.data.datasets[0].label = '🏠 Immobilier';
                    chartPrincipal.data.datasets[1].data = originalData.portfolioValueActions;
                    chartPrincipal.data.datasets[1].label = '📈 Actions';
                    
                    chartPrincipal.options.scales.y.ticks.callback = function(value) {
                        return formatCurrency(value);
                    };
                    
                    chartPrincipal.options.plugins.title.text = 'Évolution des Capitaux';
                    
                    // ADAPTER L'ÉCHELLE pour le mode Capital
                    const allCapitalValues = [...originalData.capitalImmobilier, ...originalData.portfolioValueActions];
                    const minCap = Math.min(...allCapitalValues);
                    const maxCap = Math.max(...allCapitalValues);
                    const paddingCap = Math.max((maxCap - minCap) * 0.1, 1000); // Minimum 1000€ de padding
                    
                    chartPrincipal.options.scales.y.min = minCap - paddingCap;
                    chartPrincipal.options.scales.y.max = maxCap + paddingCap;
                    
                    console.log('📏 Échelle Capital adaptée:', { minCap, maxCap, paddingCap });
                }
                
                chartPrincipal.update();
            }
        }

        // ===========================================
        // FONCTIONS POUR DONNÉES HISTORIQUES RÉELLES
        // ===========================================
        
        // Récupération synchrone des données historiques
        function getHistoricalDataSync(ticker, years) {
            console.log('📊 Récupération des données pour:', ticker, 'sur', years, 'ans');
            
            // Appel à l'API Django pour récupérer les vraies données
            try {
                const xhr = new XMLHttpRequest();
                const url = `/api/historical-data/?ticker=${encodeURIComponent(ticker)}&years=${years}`;
                
                console.log('🌐 Appel API:', url);
                
                // Appel synchrone (pour simplifier, sinon il faudrait refactoriser toute la logique)
                xhr.open('GET', url, false);
                xhr.send();
                
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    console.log('✅ Données récupérées de l\'API:', response);
                    
                    if (response.data && response.data.length > 0) {
                        return response.data;
                    } else {
                        console.log('⚠️ Pas de données dans la réponse API');
                        return generateRealisticData(ticker, years);
                    }
                } else {
                    console.log('❌ Erreur API:', xhr.status, xhr.responseText);
                    return generateRealisticData(ticker, years);
                }
                
            } catch (error) {
                console.error('❌ Erreur lors de l\'appel API:', error);
                return generateRealisticData(ticker, years);
            }
        }
        
        // Génération de données réalistes basées sur le ticker
        function generateRealisticData(ticker, years) {
            const months = years * 12;
            const data = [];
            
            // Prix initial basé sur le type d'asset
            let basePrice = 100; // Prix par défaut
            let volatility = 0.02; // Volatilité mensuelle de base
            let trend = 0.005; // Tendance mensuelle de base
            
            // Ajuster selon le ticker
            if (ticker.includes('BTC') || ticker.includes('ETH')) {
                basePrice = 2000; // Prix crypto plus élevé
                volatility = 0.08; // Plus volatile
                trend = 0.01; // Tendance plus forte
            } else if (ticker.includes('AAPL') || ticker.includes('MSFT')) {
                basePrice = 150; // Prix actions tech
                volatility = 0.04; // Volatilité modérée
                trend = 0.008; // Tendance positive
            } else if (ticker.includes('EUR')) {
                basePrice = 1; // Prix forex
                volatility = 0.01; // Peu volatile
                trend = 0.001; // Tendance faible
            }
            
            console.log('🔍 Paramètres pour', ticker, ':', { basePrice, volatility, trend });
            
            // Générer l'historique mensuel
            let currentPrice = basePrice;
            for (let i = 0; i <= months; i++) {
                data.push({
                    date: new Date(Date.now() - (months - i) * 30 * 24 * 60 * 60 * 1000),
                    price: currentPrice
                });
                
                if (i < months) {
                    // Calculer le prochain prix avec tendance + bruit
                    const randomChange = normalRandom(trend, volatility);
                    currentPrice = currentPrice * (1 + randomChange);
                    
                    // Protection contre les prix négatifs
                    currentPrice = Math.max(currentPrice, basePrice * 0.1);
                }
            }
            
            console.log('✅ Données générées:', data.length, 'points de prix');
            return data;
        }
        
        // Calcul du rendement moyen à partir des données historiques
        function calculateAverageReturn(historicalData) {
            if (historicalData.length < 2) return 0.005; // 0.5% par défaut
            
            let totalReturn = 0;
            let count = 0;
            
            for (let i = 1; i < historicalData.length; i++) {
                const currentPrice = historicalData[i].price;
                const previousPrice = historicalData[i-1].price;
                const monthlyReturn = (currentPrice - previousPrice) / previousPrice;
                totalReturn += monthlyReturn;
                count++;
            }
            
            const avgReturn = count > 0 ? totalReturn / count : 0.005;
            console.log('📈 Rendement moyen calculé:', (avgReturn * 100).toFixed(2) + '%');
            return avgReturn;
        }
        
        // Fonction de simulation de fallback (ancienne logique)
        function simulateActions(capitalInitial, loyerMensuel, mois) {
            console.log('🔄 Utilisation de la simulation de fallback');
            
            const portfolioValues = [];
            let currentValue = capitalInitial;
            
            // Paramètres de simulation
            const monthlyReturn = 0.007; // ~8.5% annuel
            const volatility = 0.025;
            
            for (let m = 1; m <= mois; m++) {
                const monthlyChange = normalRandom(monthlyReturn, volatility);
                currentValue = currentValue * (1 + monthlyChange) - loyerMensuel;
                currentValue = Math.max(currentValue, capitalInitial * 0.05);
                portfolioValues.push(currentValue);
            }
            
            return portfolioValues;
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Masquer les résultats et le chargement au démarrage
            document.getElementById('resultatsSimulation').style.display = 'none';
            document.getElementById('chargement').style.display = 'none';
        });
    </script>
</body>
</html>
