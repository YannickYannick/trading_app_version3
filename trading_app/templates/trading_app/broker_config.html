{% extends "base.html" %}
{% load static %}

{% block title %}{% if broker %}Modifier{% else %}Ajouter{% endif %} un courtier{% endblock %}

{% block content %}
<div class="container">
    <h1>{% if broker %}Modifier{% else %}Ajouter{% endif %} un courtier</h1>
    
    <form method="post" class="mt-4">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="broker_type">Type de courtier *</label>
                    <select name="broker_type" id="broker_type" class="form-control" required>
                        <option value="">Sélectionner un courtier</option>
                        {% for key, name in supported_brokers.items %}
                        <option value="{{ key }}" {% if broker and broker.broker_type == key %}selected{% endif %}>
                            {{ name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="name">Nom de la configuration *</label>
                    <input type="text" name="name" id="name" class="form-control" 
                           value="{% if broker %}{{ broker.name }}{% endif %}" required>
                    <small class="form-text text-muted">Nom pour identifier cette configuration</small>
                </div>
            </div>
        </div>
        
        <!-- Configuration Saxo -->
        <div id="saxo-config" class="broker-config" style="display: none;">
            <h3>Configuration Saxo Bank</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="saxo_client_id">Client ID *</label>
                        <input type="text" name="saxo_client_id" id="saxo_client_id" class="form-control"
                               value="{% if broker %}{{ broker.saxo_client_id }}{% endif %}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="saxo_client_secret">Client Secret *</label>
                        <input type="password" name="saxo_client_secret" id="saxo_client_secret" class="form-control"
                               value="{% if broker %}{{ broker.saxo_client_secret }}{% endif %}">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="saxo_redirect_uri">Redirect URI *</label>
                <input type="url" name="saxo_redirect_uri" id="saxo_redirect_uri" class="form-control"
                       value="{% if broker %}{{ broker.saxo_redirect_uri }}{% else %}http://localhost:8080/callback{% endif %}">
                <small class="form-text text-muted">URL de callback pour l'authentification OAuth2</small>
            </div>
            
            {% if broker and broker.saxo_access_token %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <strong>Connecté à Saxo Bank</strong><br>
                Token d'accès valide jusqu'au {{ broker.saxo_token_expires_at|date:"d/m/Y H:i" }}
            </div>
            {% endif %}
        </div>
        
        <!-- Configuration Binance -->
        <div id="binance-config" class="broker-config" style="display: none;">
            <h3>Configuration Binance</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="binance_api_key">API Key *</label>
                        <input type="text" name="binance_api_key" id="binance_api_key" class="form-control"
                               value="{% if broker %}{{ broker.binance_api_key }}{% endif %}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="binance_api_secret">API Secret *</label>
                        <input type="password" name="binance_api_secret" id="binance_api_secret" class="form-control"
                               value="{% if broker %}{{ broker.binance_api_secret }}{% endif %}">
                    </div>
                </div>
            </div>
            <div class="form-check">
                <input type="checkbox" name="binance_testnet" id="binance_testnet" class="form-check-input"
                       {% if broker and broker.binance_testnet %}checked{% endif %}>
                <label for="binance_testnet" class="form-check-label">
                    Utiliser le testnet (recommandé pour les tests)
                </label>
            </div>
        </div>
        
        <div class="mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> 
                {% if broker %}Mettre à jour{% else %}Créer{% endif %}
            </button>
            <a href="{% url 'broker_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour
            </a>
        </div>
    </form>
</div>

<script>
document.getElementById('broker_type').addEventListener('change', function() {
    const brokerType = this.value;
    const configs = document.querySelectorAll('.broker-config');
    
    // Masquer toutes les configurations
    configs.forEach(config => config.style.display = 'none');
    
    // Afficher la configuration appropriée
    if (brokerType === 'saxo') {
        document.getElementById('saxo-config').style.display = 'block';
    } else if (brokerType === 'binance') {
        document.getElementById('binance-config').style.display = 'block';
    }
});

// Afficher la configuration au chargement si un courtier est sélectionné
document.addEventListener('DOMContentLoaded', function() {
    const brokerType = document.getElementById('broker_type').value;
    if (brokerType) {
        document.getElementById('broker_type').dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %} 