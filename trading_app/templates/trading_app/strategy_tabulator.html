{% extends "base.html" %}
{% load static %}

{% block title %}Stratégies de Trading{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>Stratégies de Trading</h1>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-warning me-2" onclick="updatePortfolioQuantities()">
                <i class="fas fa-sync-alt"></i> Mettre à jour Portefeuille
            </button>
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#executeStrategyModal">
                <i class="fas fa-play"></i> Exécuter Stratégie
            </button>
            <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#executionHistoryModal">
                <i class="fas fa-history"></i> Historique
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStrategyModal">
                <i class="fas fa-plus"></i> Nouvelle Stratégie
            </button>
        </div>
    </div>

    <!-- Tableau des stratégies -->
    <div class="card">
        <div class="card-body">
<div id="strategy-table"></div>
        </div>
    </div>
</div>

<!-- ===== SECTION TABLEAU DES POSITIONS ET ORDRES ===== -->
<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-pie"></i> Vue d'ensemble des Positions et Ordres
                    </h3>
                    <p class="card-subtitle text-muted">
                        Positions et ordres en cours groupés par actif
                    </p>
                </div>
                <div class="card-body">
                    <!-- Statistiques globales -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 id="total-assets-positions">-</h4>
                                    <small>Actifs uniques</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 id="total-positions-count">-</h4>
                                    <small>Positions totales</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 id="total-pending-orders-count">-</h4>
                                    <small>Ordres en cours</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 id="net-exposure-total">-</h4>
                                    <small>Exposition nette</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bouton de rafraîchissement -->
                    <div class="row mb-3">
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-primary" onclick="loadPositionsData()">
                                <i class="fas fa-sync-alt"></i> Rafraîchir les données
                            </button>
                        </div>
                    </div>

                    <!-- Tableau Tabulator -->
                    <div id="positions-overview-table"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les détails des positions -->
<div class="modal fade" id="positionsDetailsModal" tabindex="-1" aria-labelledby="positionsDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="positionsDetailsModalLabel">Détails de l'actif</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="positionsDetailsModalBody">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ajouter/éditer une stratégie -->
<div class="modal fade" id="addStrategyModal" tabindex="-1" aria-labelledby="addStrategyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStrategyModalLabel">Nouvelle Stratégie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="strategyForm">
                    <div class="row">
                        <!-- Informations de base -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="strategyName" class="form-label">Nom de la stratégie *</label>
                                <input type="text" class="form-control" id="strategyName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="strategyAsset" class="form-label">Asset *</label>
                                <select class="form-control" id="strategyAsset" required>
                                    <option value="">Sélectionner un asset...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="strategyAlgorithm" class="form-label">Algorithme *</label>
                                <select class="form-control" id="strategyAlgorithm" required>
                                    <option value="">Sélectionner un algorithme...</option>
                                    <option value="threshold">Seuils (Threshold)</option>
                                    <option value="ma_crossover">Moving Average Crossover</option>
                                    <option value="rsi">RSI (Relative Strength Index)</option>
                                    <option value="bollinger">Bollinger Bands</option>
                                    <option value="macd">MACD</option>
                                    <option value="grid">Grid Trading</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Configuration -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="strategyBroker" class="form-label">Broker *</label>
                                <select class="form-control" id="strategyBroker" required>
                                    <option value="">Sélectionner un broker...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="strategyExecutionMode" class="form-label">Mode d'exécution *</label>
                                <select class="form-control" id="strategyExecutionMode" required>
                                    <option value="simulation">Simulation</option>
                                    <option value="paper_trading">Paper Trading</option>
                                    <option value="live_trading">Trading Réel</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="strategyFrequency" class="form-label">Fréquence de vérification (minutes)</label>
                                <input type="number" class="form-control" id="strategyFrequency" value="45" min="1" max="1440">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paramètres de l'algorithme -->
                    <div class="mb-3">
                        <label class="form-label">Paramètres de l'algorithme</label>
                        <div id="algorithmParameters">
                            <!-- Les paramètres seront générés dynamiquement -->
                        </div>
                    </div>
                    
                    <!-- Quantités cibles pour la gestion de position -->
                    <div class="mb-3">
                        <label class="form-label">Quantités cibles pour la gestion de position</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="strategyTargetMin" class="form-label">Quantité minimale cible</label>
                                    <input type="number" class="form-control" id="strategyTargetMin" 
                                           placeholder="Ex: 100" min="0" step="0.01"
                                           title="Quantité minimale d'actions à maintenir en portefeuille">
                                    <small class="form-text text-muted">Quantité minimale d'actions à maintenir</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="strategyTargetMax" class="form-label">Quantité maximale cible</label>
                                    <input type="number" class="form-control" id="strategyTargetMax" 
                                           placeholder="Ex: 180" min="0" step="0.01"
                                           title="Quantité maximale d'actions à maintenir en portefeuille">
                                    <small class="form-text text-muted">Quantité maximale d'actions à maintenir</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Gestion intelligente des positions :</strong><br>
                            • <strong>Achat :</strong> Si le prix est en dessous du seuil bas ET que la position est inférieure au maximum<br>
                            • <strong>Vente :</strong> Si le prix est au-dessus du seuil haut ET que la position est supérieure au minimum<br>
                            • <strong>HOLD :</strong> Si la position est déjà au minimum ou au maximum<br>
                            • <strong>Quantité automatique :</strong> La quantité à trader est calculée automatiquement selon les objectifs
                        </div>
                    </div>
                    
                    <!-- Commentaires -->
                    <div class="mb-3">
                        <label for="strategyComments" class="form-label">Commentaires</label>
                        <textarea class="form-control" id="strategyComments" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveStrategyBtn">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour voir les détails d'une stratégie -->
<div class="modal fade" id="strategyDetailsModal" tabindex="-1" aria-labelledby="strategyDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="strategyDetailsModalLabel">Détails de la Stratégie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="strategyDetails">
                    <!-- Les détails seront chargés dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour voir l'historique des exécutions d'une stratégie -->
<div class="modal fade" id="strategyExecutionsModal" tabindex="-1" aria-labelledby="strategyExecutionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="strategyExecutionsModalLabel">Historique des Exécutions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="strategyExecutionsTable">
                    <!-- L'historique des exécutions sera chargé dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour éditer une stratégie -->
<div class="modal fade" id="editStrategyModal" tabindex="-1" aria-labelledby="editStrategyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStrategyModalLabel">Modifier la Stratégie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStrategyForm">
                    <input type="hidden" id="editStrategyId">
                    <div class="row">
                        <!-- Informations de base -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStrategyName" class="form-label">Nom de la stratégie *</label>
                                <input type="text" class="form-control" id="editStrategyName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editStrategyAsset" class="form-label">Asset *</label>
                                <select class="form-control" id="editStrategyAsset" required>
                                    <option value="">Sélectionner un asset...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editStrategyAlgorithm" class="form-label">Algorithme *</label>
                                <select class="form-control" id="editStrategyAlgorithm" required>
                                    <option value="">Sélectionner un algorithme...</option>
                                    <option value="threshold">Seuils (Threshold)</option>
                                    <option value="ma_crossover">Moving Average Crossover</option>
                                    <option value="rsi">RSI (Relative Strength Index)</option>
                                    <option value="bollinger">Bollinger Bands</option>
                                    <option value="macd">MACD</option>
                                    <option value="grid">Grid Trading</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Configuration -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStrategyBroker" class="form-label">Broker *</label>
                                <select class="form-control" id="editStrategyBroker" required>
                                    <option value="">Sélectionner un broker...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editStrategyExecutionMode" class="form-label">Mode d'exécution *</label>
                                <select class="form-control" id="editStrategyExecutionMode" required>
                                    <option value="simulation">Simulation</option>
                                    <option value="paper_trading">Paper Trading</option>
                                    <option value="live_trading">Trading Réel</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editStrategyFrequency" class="form-label">Fréquence de vérification (minutes)</label>
                                <input type="number" class="form-control" id="editStrategyFrequency" value="45" min="1" max="1440">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paramètres de l'algorithme -->
                    <div class="mb-3">
                        <label class="form-label">Paramètres de l'algorithme</label>
                        <div id="editAlgorithmParameters">
                            <!-- Les paramètres seront générés dynamiquement -->
                        </div>
                    </div>
                    
                    <!-- Quantités cibles pour la gestion de position -->
                    <div class="mb-3">
                        <label class="form-label">Quantités cibles pour la gestion de position</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStrategyTargetMin" class="form-label">Quantité minimale cible</label>
                                    <input type="number" class="form-control" id="editStrategyTargetMin" 
                                           placeholder="Ex: 100" min="0" step="0.01"
                                           title="Quantité minimale d'actions à maintenir en portefeuille">
                                    <small class="form-text text-muted">Quantité minimale d'actions à maintenir</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStrategyTargetMax" class="form-label">Quantité maximale cible</label>
                                    <input type="number" class="form-control" id="editStrategyTargetMax" 
                                           placeholder="Ex: 180" min="0" step="0.01"
                                           title="Quantité maximale d'actions à maintenir en portefeuille">
                                    <small class="form-text text-muted">Quantité maximale d'actions à maintenir</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Gestion intelligente des positions :</strong><br>
                            • <strong>Achat :</strong> Si le prix est en dessous du seuil bas ET que la position est inférieure au maximum<br>
                            • <strong>Vente :</strong> Si le prix est au-dessus du seuil haut ET que la position est supérieure au minimum<br>
                            • <strong>HOLD :</strong> Si la position est déjà au minimum ou au maximum
                        </div>
                    </div>
                    
                    <!-- Commentaires -->
                    <div class="mb-3">
                        <label for="editStrategyComments" class="form-label">Commentaires</label>
                        <textarea class="form-control" id="editStrategyComments" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="updateStrategyBtn">Mettre à jour</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour exécuter une stratégie manuellement -->
<div class="modal fade" id="executeStrategyModal" tabindex="-1" aria-labelledby="executeStrategyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="executeStrategyModalLabel">Exécuter Stratégie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="executeStrategySelect" class="form-label">Sélectionner une stratégie</label>
                    <select class="form-control" id="executeStrategySelect">
                        <option value="">Choisir une stratégie...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="executeFrequency" class="form-label">Fréquence d'exécution (minutes)</label>
                    <input type="number" class="form-control" id="executeFrequency" value="45" min="1" max="1440">
                    <small class="form-text text-muted">Cette fréquence sera appliquée à la stratégie sélectionnée</small>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> L'exécution manuelle lance immédiatement la stratégie. 
                    Pour une exécution automatique, activez la stratégie et elle s'exécutera selon sa fréquence configurée.
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-sync-alt"></i>
                    <strong>Mise à jour automatique:</strong> Les prix de l'asset seront automatiquement mis à jour via Yahoo Finance avant l'exécution de la stratégie pour garantir des données fraîches.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="executeStrategyBtn">Exécuter Maintenant</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour l'historique des exécutions -->
<div class="modal fade" id="executionHistoryModal" tabindex="-1" aria-labelledby="executionHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="executionHistoryModalLabel">Historique des Exécutions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtres -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="historyStrategyFilter" class="form-label">Stratégie</label>
                        <select class="form-control" id="historyStrategyFilter">
                            <option value="">Toutes les stratégies</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="historySignalFilter" class="form-label">Signal</label>
                        <select class="form-control" id="historySignalFilter">
                            <option value="">Tous les signaux</option>
                            <option value="BUY">Achat</option>
                            <option value="SELL">Vente</option>
                            <option value="HOLD">Attendre</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="historyDateFrom" class="form-label">Date début</label>
                        <input type="date" class="form-control" id="historyDateFrom">
                    </div>
                    <div class="col-md-3">
                        <label for="historyDateTo" class="form-label">Date fin</label>
                        <input type="date" class="form-control" id="historyDateTo">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" id="applyHistoryFilters">
                            <i class="fas fa-filter"></i> Appliquer les filtres
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearHistoryFilters">
                            <i class="fas fa-times"></i> Effacer les filtres
                        </button>
                    </div>
                </div>
                
                <!-- Tableau de l'historique -->
                <div id="execution-history-table"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- CSS et JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.3/css/tabulator.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.3/js/tabulator.min.js"></script>

<style>
/* Styles pour le tableau des positions et ordres */
.asset-row {
    background-color: #e3f2fd !important;
    font-weight: bold;
    border-left: 4px solid #2196F3 !important;
}

.position-row {
    background-color: #f1f8e9 !important;
    border-left: 4px solid #4CAF50 !important;
}

.pending-order-row {
    background-color: #fff3e0 !important;
    border-left: 4px solid #FF9800 !important;
}

.side-buy {
    color: #4CAF50;
    font-weight: bold;
}

.side-sell {
    color: #f44336;
    font-weight: bold;
}

.net-positive {
    color: #4CAF50;
    font-weight: bold;
}

.net-negative {
    color: #f44336;
    font-weight: bold;
}

.net-zero {
    color: #757575;
}

/* Styles pour les statistiques */
.card.bg-primary, .card.bg-success, .card.bg-warning, .card.bg-info {
    transition: transform 0.2s;
}

.card.bg-primary:hover, .card.bg-success:hover, .card.bg-warning:hover, .card.bg-info:hover {
    transform: translateY(-2px);
}

/* Styles pour le modal */
.modal-lg .table {
    font-size: 0.9rem;
}

.modal-lg .table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
</style>

<script>
// Données globales
var strategiesData = {{ data_strategies|default:"[]"|safe }};
var assetsData = {{ assets_data|default:"[]"|safe }};
var brokersData = {{ brokers_data|default:"[]"|safe }};

// Configuration des paramètres par algorithme
var algorithmParameters = {
    'threshold': [
        {name: 'threshold_low', label: 'Seuil bas', type: 'number', default: 100.0},
        {name: 'threshold_high', label: 'Seuil haut', type: 'number', default: 200.0},
        {name: 'order_size', label: 'Limite max par trade', type: 'number', default: 1000.0, help: 'Quantité maximale d\'actions par trade (sécurité)'},
        {name: 'stop_loss', label: 'Stop Loss (%)', type: 'number', default: 5.0}
    ],
    'ma_crossover': [
        {name: 'ma1_period', label: 'Période MA1', type: 'number', default: 20},
        {name: 'ma2_period', label: 'Période MA2', type: 'number', default: 50},
        {name: 'order_size', label: 'Taille ordre', type: 'number', default: 1.0},
        {name: 'stop_loss', label: 'Stop Loss (%)', type: 'number', default: 5.0}
    ],
    'rsi': [
        {name: 'rsi_period', label: 'Période RSI', type: 'number', default: 14},
        {name: 'rsi_low', label: 'Seuil bas RSI', type: 'number', default: 30},
        {name: 'rsi_high', label: 'Seuil haut RSI', type: 'number', default: 70},
        {name: 'order_size', label: 'Taille ordre', type: 'number', default: 1.0},
        {name: 'stop_loss', label: 'Stop Loss (%)', type: 'number', default: 5.0}
    ],
    'bollinger': [
        {name: 'bb_period', label: 'Période', type: 'number', default: 20},
        {name: 'bb_std', label: 'Écart-type', type: 'number', default: 2.0},
        {name: 'order_size', label: 'Taille ordre', type: 'number', default: 1.0},
        {name: 'stop_loss', label: 'Stop Loss (%)', type: 'number', default: 5.0}
    ],
    'macd': [
        {name: 'macd_fast', label: 'Période rapide', type: 'number', default: 12},
        {name: 'macd_slow', label: 'Période lente', type: 'number', default: 26},
        {name: 'macd_signal', label: 'Période signal', type: 'number', default: 9},
        {name: 'order_size', label: 'Taille ordre', type: 'number', default: 1.0},
        {name: 'stop_loss', label: 'Stop Loss (%)', type: 'number', default: 5.0}
    ],
    'grid': [
        {name: 'grid_min', label: 'Prix minimum', type: 'number', default: 100.0},
        {name: 'grid_max', label: 'Prix maximum', type: 'number', default: 200.0},
        {name: 'grid_levels', label: 'Nombre de niveaux', type: 'number', default: 10},
        {name: 'order_size', label: 'Taille ordre', type: 'number', default: 1.0},
        {name: 'stop_loss', label: 'Stop Loss (%)', type: 'number', default: 5.0}
    ]
};

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    initializeTable();
    populateDropdowns();
    setupEventListeners();
    initializeModals();
});

// Initialiser le tableau
function initializeTable() {
    var table = new Tabulator("#strategy-table", {
        height: "500px",
        layout: "fitData",
        data: strategiesData,
        columns: [
            {title: "Nom", field: "name", headerFilter: "input", width: 120},
            {title: "Asset", field: "asset_name", headerFilter: "input", width: 80},
            {title: "Portefeuille", field: "portfolio_quantity", formatter: function(cell) {
                var quantity = parseFloat(cell.getValue()) || 0;
                if (quantity === 0) {
                    return '<span class="text-muted">0</span>';
                } else {
                    var color = quantity > 0 ? 'success' : 'danger';
                    return '<span class="text-' + color + ' fw-bold">' + quantity.toFixed(2) + '</span>';
                }
            }, headerFilter: "input", width: 100},
            {title: "Seuils Cibles", field: "target_min_quantity", formatter: function(cell) {
                var row = cell.getRow();
                var minQty = parseFloat(cell.getValue()) || 0;
                var maxQty = parseFloat(row.getData().target_max_quantity) || 0;
                
                if (minQty === 0 && maxQty === 0) {
                    return '<span class="text-muted">-</span>';
                } else {
                    var minText = minQty > 0 ? '<span class="text-info">' + minQty.toFixed(2) + '</span>' : '';
                    var maxText = maxQty > 0 ? '<span class="text-warning">' + maxQty.toFixed(2) + '</span>' : '';
                    var separator = minQty > 0 && maxQty > 0 ? ' → ' : '';
                    return minText + separator + maxText;
                }
            }, headerFilter: "input", width: 120},
            {title: "Algorithme", field: "algorithm_type_display", headerFilter: "select", width: 140},
            {title: "Broker", field: "broker_name", headerFilter: "input", width: 80},
            {title: "Mode", field: "execution_mode_display", headerFilter: "select", width: 100},
            {title: "Configuration", field: "status", formatter: function(cell) {
                var row = cell.getRow();
                var status = cell.getValue();
                var frequency = row.getData().check_frequency;
                var color = status === 'active' ? 'success' : status === 'inactive' ? 'secondary' : 'warning';
                return '<div><span class="badge bg-' + color + '">' + status + '</span><br><small class="text-muted">' + frequency + ' min</small></div>';
            }, headerFilter: "select", width: 100},
            {title: "Performance", field: "total_trades", formatter: function(cell) {
                var row = cell.getRow();
                var total = cell.getValue();
                var successful = row.getData().successful_trades || 0;
                var pnl = parseFloat(row.getData().total_pnl) || 0;
                var pnlColor = pnl >= 0 ? 'success' : 'danger';
                
                return '<div><small>' + total + ' (' + successful + ' réussis)</small><br>' +
                       '<span class="text-' + pnlColor + ' fw-bold">' + pnl.toFixed(2) + ' €</span></div>';
            }, headerFilter: "input", width: 120},
            {title: "Actions", formatter: function(cell) {
                var row = cell.getRow();
                var data = row.getData();
                return '<div class="btn-group btn-group-sm" role="group">' +
                       '<button class="btn btn-outline-info" title="Voir" onclick="viewStrategy(' + data.id + ')"><i class="fas fa-eye"></i></button>' +
                       '<button class="btn btn-outline-primary" title="Modifier" onclick="editStrategy(' + data.id + ')"><i class="fas fa-edit"></i></button>' +
                       '<button class="btn btn-outline-warning" title="' + (data.status === 'active' ? 'Pause' : 'Activer') + '" onclick="toggleStrategy(' + data.id + ')"><i class="fas fa-' + 
                       (data.status === 'active' ? 'pause' : 'play') + '"></i></button>' +
                       '<button class="btn btn-outline-success" title="Exécuter" onclick="executeStrategyDirect(' + data.id + ')"><i class="fas fa-rocket"></i></button>' +
                       '<button class="btn btn-outline-secondary" title="Historique Exécutions" onclick="viewStrategyExecutions(' + data.id + ')"><i class="fas fa-history"></i></button>' +
                       '<button class="btn btn-outline-danger" title="Supprimer" onclick="deleteStrategy(' + data.id + ')"><i class="fas fa-trash"></i></button>' +
                       '</div>';
            }, width: 260, hozAlign: "center"}
        ]
    });
}

// Remplir les dropdowns
function populateDropdowns() {
    // Assets
    var assetSelect = document.getElementById('strategyAsset');
    var editAssetSelect = document.getElementById('editStrategyAsset');
    assetsData.forEach(function(asset) {
        var option = document.createElement('option');
        option.value = asset.id;
        option.textContent = asset.symbol_clean + ' - ' + asset.name;
        assetSelect.appendChild(option);
        
        // Dupliquer pour le modal d'édition
        var editOption = document.createElement('option');
        editOption.value = asset.id;
        editOption.textContent = asset.symbol_clean + ' - ' + asset.name;
        editAssetSelect.appendChild(editOption);
    });
    
    // Brokers
    var brokerSelect = document.getElementById('strategyBroker');
    var editBrokerSelect = document.getElementById('editStrategyBroker');
    brokersData.forEach(function(broker) {
        var option = document.createElement('option');
        option.value = broker.id;
        option.textContent = broker.name + ' (' + broker.broker_type + ')';
        brokerSelect.appendChild(option);
        
        // Dupliquer pour le modal d'édition
        var editOption = document.createElement('option');
        editOption.value = broker.id;
        editOption.textContent = broker.name + ' (' + broker.broker_type + ')';
        editBrokerSelect.appendChild(editOption);
    });
}

// Configurer les event listeners
function setupEventListeners() {
    // Changement d'algorithme
    document.getElementById('strategyAlgorithm').addEventListener('change', function() {
        updateAlgorithmParameters();
    });
    
    // Changement d'algorithme dans l'édition
    document.getElementById('editStrategyAlgorithm').addEventListener('change', function() {
        updateEditAlgorithmParameters(this.value, {});
    });
    
    // Sauvegarder la stratégie
    document.getElementById('saveStrategyBtn').addEventListener('click', function() {
        saveStrategy();
    });
    
    // Mettre à jour la stratégie
    document.getElementById('updateStrategyBtn').addEventListener('click', function() {
        updateStrategy();
    });
    
    // Exécuter stratégie
    document.getElementById('executeStrategyBtn').addEventListener('click', function() {
        executeStrategy();
    });
    
    // Historique - Appliquer filtres
    document.getElementById('applyHistoryFilters').addEventListener('click', function() {
        loadExecutionHistory();
    });
    
    // Historique - Effacer filtres
    document.getElementById('clearHistoryFilters').addEventListener('click', function() {
        clearHistoryFilters();
    });
    
    // Charger l'historique quand le modal s'ouvre
    document.getElementById('executionHistoryModal').addEventListener('shown.bs.modal', function() {
        loadExecutionHistory();
    });
}

// Mettre à jour les paramètres selon l'algorithme
function updateAlgorithmParameters() {
    var algorithm = document.getElementById('strategyAlgorithm').value;
    var container = document.getElementById('algorithmParameters');
    container.innerHTML = '';
    
    if (algorithm && algorithmParameters[algorithm]) {
        algorithmParameters[algorithm].forEach(function(param) {
            var div = document.createElement('div');
            div.className = 'mb-2';
            div.innerHTML = `
                <label for="param_${param.name}" class="form-label">${param.label}</label>
                <input type="${param.type}" class="form-control" id="param_${param.name}" 
                       value="${param.default}" step="any">
            `;
            container.appendChild(div);
        });
    }
}

// Sauvegarder la stratégie
function saveStrategy() {
    var frequency = parseInt(document.getElementById('strategyFrequency').value);
    if (isNaN(frequency) || frequency < 1 || frequency > 1440) {
        alert('Fréquence invalide (doit être entre 1 et 1440 minutes)');
        return;
    }
    
    var formData = {
        name: document.getElementById('strategyName').value,
        asset: document.getElementById('strategyAsset').value,
        algorithm_type: document.getElementById('strategyAlgorithm').value,
        broker: document.getElementById('strategyBroker').value,
        execution_mode: document.getElementById('strategyExecutionMode').value,
        check_frequency: frequency,
        comments: document.getElementById('strategyComments').value,
        parameters: getAlgorithmParameters(),
        target_min_quantity: parseFloat(document.getElementById('strategyTargetMin').value) || 0,
        target_max_quantity: parseFloat(document.getElementById('strategyTargetMax').value) || 0
    };
    
    // Validation
    if (!formData.name || !formData.asset || !formData.algorithm_type || !formData.broker) {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
    }
    
    // Envoyer à l'API
    fetch('/strategies/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Stratégie créée avec succès !');
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la création de la stratégie');
    });
}

// Récupérer les paramètres de l'algorithme
function getAlgorithmParameters() {
    var algorithm = document.getElementById('strategyAlgorithm').value;
    var params = {};
    
    if (algorithm && algorithmParameters[algorithm]) {
        algorithmParameters[algorithm].forEach(function(param) {
            var value = document.getElementById('param_' + param.name).value;
            params[param.name] = parseFloat(value);
        });
    }
    
    return params;
}

// Voir les détails d'une stratégie
function viewStrategy(strategyId) {
    fetch('/strategies/' + strategyId + '/details/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('strategyDetails').innerHTML = formatStrategyDetails(data.strategy);
            new bootstrap.Modal(document.getElementById('strategyDetailsModal')).show();
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

// Voir l'historique des exécutions d'une stratégie
function viewStrategyExecutions(strategyId) {
    fetch('/strategies/' + strategyId + '/executions/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('strategyExecutionsTable').innerHTML = formatStrategyExecutions(data.executions, data.strategy);
            new bootstrap.Modal(document.getElementById('strategyExecutionsModal')).show();
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

// Éditer une stratégie
function editStrategy(strategyId) {
    fetch('/strategies/' + strategyId + '/details/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateEditForm(data.strategy);
            new bootstrap.Modal(document.getElementById('editStrategyModal')).show();
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

// Remplir le formulaire d'édition
function populateEditForm(strategy) {
    // ID de la stratégie
    document.getElementById('editStrategyId').value = strategy.id;
    
    // Informations de base
    document.getElementById('editStrategyName').value = strategy.name;
    document.getElementById('editStrategyAsset').value = strategy.asset_id || '';
    document.getElementById('editStrategyAlgorithm').value = strategy.algorithm_type;
    document.getElementById('editStrategyBroker').value = strategy.broker_id || '';
    document.getElementById('editStrategyExecutionMode').value = strategy.execution_mode;
    document.getElementById('editStrategyFrequency').value = strategy.check_frequency;
    document.getElementById('editStrategyComments').value = strategy.comments || '';
    
    // Quantités cibles
    document.getElementById('editStrategyTargetMin').value = strategy.target_min_quantity || '';
    document.getElementById('editStrategyTargetMax').value = strategy.target_max_quantity || '';
    
    // Générer les paramètres de l'algorithme
    updateEditAlgorithmParameters(strategy.algorithm_type, strategy.parameters);
}

// Mettre à jour les paramètres d'édition selon l'algorithme
function updateEditAlgorithmParameters(algorithm, currentParams) {
    var container = document.getElementById('editAlgorithmParameters');
    container.innerHTML = '';
    
    if (algorithm && algorithmParameters[algorithm]) {
        algorithmParameters[algorithm].forEach(function(param) {
            var div = document.createElement('div');
            div.className = 'mb-2';
            var currentValue = currentParams && currentParams[param.name] !== undefined ? currentParams[param.name] : param.default;
            div.innerHTML = `
                <label for="edit_param_${param.name}" class="form-label">${param.label}</label>
                <input type="${param.type}" class="form-control" id="edit_param_${param.name}" 
                       value="${currentValue}" step="any">
            `;
            container.appendChild(div);
        });
    }
}

// Mettre à jour une stratégie
function updateStrategy() {
    var strategyId = document.getElementById('editStrategyId').value;
    var frequency = parseInt(document.getElementById('editStrategyFrequency').value);
    
    if (isNaN(frequency) || frequency < 1 || frequency > 1440) {
        alert('Fréquence invalide (doit être entre 1 et 1440 minutes)');
        return;
    }
    
    var formData = {
        name: document.getElementById('editStrategyName').value,
        asset: document.getElementById('editStrategyAsset').value,
        algorithm_type: document.getElementById('editStrategyAlgorithm').value,
        broker: document.getElementById('editStrategyBroker').value,
        execution_mode: document.getElementById('editStrategyExecutionMode').value,
        check_frequency: frequency,
        comments: document.getElementById('editStrategyComments').value,
        parameters: getEditAlgorithmParameters(),
        target_min_quantity: parseFloat(document.getElementById('editStrategyTargetMin').value) || 0,
        target_max_quantity: parseFloat(document.getElementById('editStrategyTargetMax').value) || 0
    };
    
    // Validation
    if (!formData.name || !formData.asset || !formData.algorithm_type || !formData.broker) {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
    }
    
    // Envoyer à l'API
    fetch('/strategies/' + strategyId + '/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Stratégie mise à jour avec succès !');
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la mise à jour de la stratégie');
    });
}

// Récupérer les paramètres d'édition de l'algorithme
function getEditAlgorithmParameters() {
    var algorithm = document.getElementById('editStrategyAlgorithm').value;
    var params = {};
    
    if (algorithm && algorithmParameters[algorithm]) {
        algorithmParameters[algorithm].forEach(function(param) {
            var value = document.getElementById('edit_param_' + param.name).value;
            params[param.name] = parseFloat(value);
        });
    }
    
    return params;
}

// Formater les détails d'une stratégie
function formatStrategyDetails(strategy) {
    return `
        <div class="row">
            <div class="col-md-6">
                <h6>Informations générales</h6>
                <p><strong>Nom:</strong> ${strategy.name}</p>
                <p><strong>Asset:</strong> ${strategy.asset_name}</p>
                <p><strong>Algorithme:</strong> ${strategy.algorithm_type_display}</p>
                <p><strong>Broker:</strong> ${strategy.broker_name}</p>
                <p><strong>Mode:</strong> ${strategy.execution_mode_display}</p>
                <p><strong>Statut:</strong> <span class="badge bg-${strategy.status === 'active' ? 'success' : 'secondary'}">${strategy.status}</span></p>
            </div>
            <div class="col-md-6">
                <h6>Statistiques</h6>
                <p><strong>Total trades:</strong> ${strategy.total_trades}</p>
                <p><strong>Trades réussis:</strong> ${strategy.successful_trades}</p>
                <p><strong>P&L total:</strong> <span class="text-${parseFloat(strategy.total_pnl) >= 0 ? 'success' : 'danger'}">${strategy.total_pnl} €</span></p>
                <p><strong>Dernière exécution:</strong> ${strategy.last_execution || 'Jamais'}</p>
                <p><strong>Fréquence:</strong> ${strategy.check_frequency} minutes</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Paramètres</h6>
                <pre>${JSON.stringify(strategy.parameters, null, 2)}</pre>
            </div>
        </div>
        ${strategy.comments ? `
        <div class="row mt-3">
            <div class="col-12">
                <h6>Commentaires</h6>
                <p>${strategy.comments}</p>
            </div>
        </div>
        ` : ''}
    `;
}

// Formater l'historique des exécutions d'une stratégie
function formatStrategyExecutions(executions, strategy) {
    if (!executions || executions.length === 0) {
        return `
            <div class="text-center text-muted">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <h5>Aucune exécution trouvée</h5>
                <p>Cette stratégie n'a pas encore été exécutée.</p>
            </div>
        `;
    }
    
    let executionsHtml = `
        <div class="row mb-3">
            <div class="col-12">
                <h6>Historique des exécutions pour ${strategy.name} (${strategy.asset_name})</h6>
                <p class="text-muted">Total: ${executions.length} exécutions</p>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Date/Heure</th>
                        <th>Signal</th>
                        <th>Prix</th>
                        <th>Force</th>
                        <th>Ordre Exécuté</th>
                        <th>Taille Ordre</th>
                        <th>Prix Ordre</th>
                        <th>Durée</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    executions.forEach(execution => {
        const date = new Date(execution.execution_time).toLocaleString('fr-FR');
        const signalClass = execution.signal === 'BUY' ? 'success' : execution.signal === 'SELL' ? 'danger' : 'secondary';
        const orderExecutedClass = execution.order_executed ? 'success' : 'warning';
        const duration = execution.execution_duration ? execution.execution_duration.toFixed(2) + 's' : '-';
        
        executionsHtml += `
            <tr>
                <td>${date}</td>
                <td><span class="badge bg-${signalClass}">${execution.signal}</span></td>
                <td>${execution.current_price} €</td>
                <td>${execution.signal_strength.toFixed(2)}</td>
                <td><span class="badge bg-${orderExecutedClass}">${execution.order_executed ? 'Oui' : 'Non'}</span></td>
                <td>${execution.order_size || '-'}</td>
                <td>${execution.order_price || '-'}</td>
                <td>${duration}</td>
            </tr>
        `;
    });
    
    executionsHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    return executionsHtml;
}

// Activer/Désactiver une stratégie
function toggleStrategy(strategyId) {
    var action = confirm('Voulez-vous changer le statut de cette stratégie ?');
    if (action) {
        fetch('/strategies/' + strategyId + '/toggle/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
}

// Supprimer une stratégie
function deleteStrategy(strategyId) {
    var action = confirm('Êtes-vous sûr de vouloir supprimer cette stratégie ?');
    if (action) {
        fetch('/strategies/' + strategyId + '/delete/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
}

// Fonction utilitaire pour récupérer le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Variables globales pour l'historique
var executionHistoryTable = null;
var executionHistoryData = [];

// Initialiser les modals
function initializeModals() {
    // Remplir le dropdown des stratégies pour l'exécution
    var executeSelect = document.getElementById('executeStrategySelect');
    strategiesData.forEach(function(strategy) {
        var option = document.createElement('option');
        option.value = strategy.id;
        option.textContent = strategy.name + ' (' + strategy.asset_name + ')';
        executeSelect.appendChild(option);
    });
    
    // Remplir le dropdown des stratégies pour l'historique
    var historySelect = document.getElementById('historyStrategyFilter');
    strategiesData.forEach(function(strategy) {
        var option = document.createElement('option');
        option.value = strategy.id;
        option.textContent = strategy.name + ' (' + strategy.asset_name + ')';
        historySelect.appendChild(option);
    });
    
    // Initialiser le tableau d'historique
    initializeHistoryTable();
}

// Initialiser le tableau d'historique
function initializeHistoryTable() {
    executionHistoryTable = new Tabulator("#execution-history-table", {
        height: "400px",
        layout: "fitColumns",
        data: [],
        columns: [
            {title: "Date", field: "execution_time", formatter: function(cell) {
                return new Date(cell.getValue()).toLocaleString('fr-FR');
            }},
            {title: "Stratégie", field: "strategy_name"},
            {title: "Signal", field: "signal", formatter: function(cell) {
                var signal = cell.getValue();
                var color = signal === 'BUY' ? 'success' : signal === 'SELL' ? 'danger' : 'secondary';
                return '<span class="badge bg-' + color + '">' + signal + '</span>';
            }},
            {title: "Force", field: "signal_strength", formatter: function(cell) {
                return (cell.getValue() * 100).toFixed(1) + '%';
            }},
            {title: "Prix", field: "current_price", formatter: function(cell) {
                return parseFloat(cell.getValue()).toFixed(2) + ' €';
            }},
            {title: "Ordre exécuté", field: "order_executed", formatter: function(cell) {
                return cell.getValue() ? '<span class="badge bg-success">Oui</span>' : '<span class="badge bg-secondary">Non</span>';
            }},
            {title: "Taille", field: "order_size", formatter: function(cell) {
                return cell.getValue() ? parseFloat(cell.getValue()).toFixed(2) : '-';
            }},
            {title: "Prix ordre", field: "order_price", formatter: function(cell) {
                return cell.getValue() ? parseFloat(cell.getValue()).toFixed(2) + ' €' : '-';
            }},
            {title: "Durée", field: "execution_duration", formatter: function(cell) {
                return cell.getValue() ? (cell.getValue() * 1000).toFixed(0) + ' ms' : '-';
            }},
            {title: "Erreur", field: "error_message", formatter: function(cell) {
                return cell.getValue() ? '<span class="text-danger">' + cell.getValue() + '</span>' : '-';
            }}
        ]
    });
}

// Exécuter une stratégie manuellement (depuis le modal)
function executeStrategy() {
    var strategyId = document.getElementById('executeStrategySelect').value;
    var frequency = parseInt(document.getElementById('executeFrequency').value);
    
    if (!strategyId) {
        alert('Veuillez sélectionner une stratégie');
        return;
    }
    
    if (isNaN(frequency) || frequency < 1 || frequency > 1440) {
        alert('Fréquence invalide (doit être entre 1 et 1440 minutes)');
        return;
    }
    
    // Mettre à jour la fréquence de la stratégie
    fetch('/strategies/' + strategyId + '/update-frequency/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({frequency: frequency})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Exécuter la stratégie
            return fetch('/strategies/' + strategyId + '/execute/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
        } else {
            throw new Error(data.error);
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Stratégie exécutée avec succès !\n\n📊 Signal: ' + data.signal + '\n💡 Raison: ' + data.reason + '\n🔄 Prix mis à jour avant exécution');
            // Fermer le modal
            bootstrap.Modal.getInstance(document.getElementById('executeStrategyModal')).hide();
        } else {
            alert('Erreur lors de l\'exécution: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'exécution de la stratégie');
    });
}

// Exécuter une stratégie directement depuis le bouton (nouvelle fonction)
function executeStrategyDirect(strategyId) {
    if (!strategyId) {
        alert('ID de stratégie manquant');
        return;
    }
    
    if (confirm('Voulez-vous exécuter cette stratégie maintenant ?\n\n⚠️ Note: Les prix seront automatiquement mis à jour avant l\'exécution.')) {
        // Afficher un indicateur de chargement
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mise à jour...';
        button.disabled = true;
        
        // Exécuter la stratégie directement
        fetch('/strategies/' + strategyId + '/execute/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Stratégie exécutée avec succès !\n\n📊 Signal: ' + data.signal + '\n💡 Raison: ' + data.reason + '\n🔄 Prix mis à jour avant exécution');
                // Recharger le tableau pour mettre à jour les données
                if (typeof table !== 'undefined') {
                    table.setData(strategiesData);
                }
            } else {
                alert('Erreur lors de l\'exécution: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'exécution de la stratégie');
        })
        .finally(() => {
            // Restaurer le bouton
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

// Charger l'historique des exécutions
function loadExecutionHistory() {
    var strategyId = document.getElementById('historyStrategyFilter').value;
    var signal = document.getElementById('historySignalFilter').value;
    var dateFrom = document.getElementById('historyDateFrom').value;
    var dateTo = document.getElementById('historyDateTo').value;
    
    var params = new URLSearchParams();
    if (strategyId) params.append('strategy', strategyId);
    if (signal) params.append('signal', signal);
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    
    fetch('/strategies/execution-history/?' + params.toString())
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            executionHistoryData = data.executions;
            executionHistoryTable.setData(executionHistoryData);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors du chargement de l\'historique');
    });
}

// Effacer les filtres de l'historique
function clearHistoryFilters() {
    document.getElementById('historyStrategyFilter').value = '';
    document.getElementById('historySignalFilter').value = '';
    document.getElementById('historyDateFrom').value = '';
    document.getElementById('historyDateTo').value = '';
    loadExecutionHistory();
}

// ===== TABLEAU DES POSITIONS ET ORDRES =====

// Configuration du tableau des positions et ordres
const positionsTable = new Tabulator("#positions-overview-table", {
    data: [],
    layout: "fitDataFill",
    pagination: true,
    paginationSize: 20,
    paginationSizeSelector: [10, 20, 50, 100],
    height: "600px",
    columns: [
        {
            title: "Symbole",
            field: "symbol",
            headerFilter: true,
            formatter: function(cell) {
                const row = cell.getRow();
                if (row.getData().type === 'asset') {
                    return `<strong>${cell.getValue()}</strong>`;
                }
                return cell.getValue();
            }
        },
        {
            title: "Nom",
            field: "name",
            headerFilter: true,
            width: 200
        },
        {
            title: "Type",
            field: "type",
            headerFilter: true,
            formatter: function(cell) {
                const type = cell.getValue();
                if (type === 'asset') {
                    return '<span class="badge bg-primary">Asset</span>';
                } else if (type === 'position') {
                    return '<span class="badge bg-success">Position</span>';
                } else if (type === 'pending_order') {
                    return '<span class="badge bg-warning">Ordre</span>';
                }
                return type;
            }
        },
        {
            title: "Side",
            field: "side",
            headerFilter: true,
            formatter: function(cell) {
                const side = cell.getValue();
                if (side === 'BUY') {
                    return '<span class="side-buy">BUY</span>';
                } else if (side === 'SELL') {
                    return '<span class="side-sell">SELL</span>';
                }
                return side || '-';
            }
        },
        {
            title: "Taille/Quantité",
            field: "size",
            headerFilter: false,
            formatter: function(cell) {
                const row = cell.getRow();
                const data = row.getData();
                
                if (data.type === 'asset') {
                    return `<strong>Net: ${data.net_position.toFixed(2)}</strong>`;
                } else if (data.type === 'position') {
                    return data.size.toFixed(2);
                } else if (data.type === 'pending_order') {
                    return `${data.quantity.toFixed(2)} (${data.executed_quantity.toFixed(2)} exécuté)`;
                }
                return '-';
            }
        },
        {
            title: "Prix",
            field: "price",
            headerFilter: false,
            formatter: function(cell) {
                const row = cell.getRow();
                const data = row.getData();
                
                if (data.type === 'position') {
                    return `Entrée: ${data.entry_price?.toFixed(4) || '-'}<br>Actuel: ${data.current_price?.toFixed(4) || '-'}`;
                } else if (data.type === 'pending_order') {
                    return data.price ? data.price.toFixed(4) : 'Market';
                }
                return '-';
            }
        },
        {
            title: "P&L",
            field: "pnl",
            headerFilter: false,
            formatter: function(cell) {
                const row = cell.getRow();
                const data = row.getData();
                
                if (data.type === 'position') {
                    const pnl = data.pnl || 0;
                    const className = pnl > 0 ? 'net-positive' : pnl < 0 ? 'net-negative' : 'net-zero';
                    return `<span class="${className}">${pnl.toFixed(2)}</span>`;
                }
                return '-';
            }
        },
        {
            title: "Statut",
            field: "status",
            headerFilter: true,
            formatter: function(cell) {
                const status = cell.getValue();
                if (!status) return '-';
                
                let badgeClass = 'bg-secondary';
                if (status === 'OPEN') badgeClass = 'bg-success';
                else if (status === 'CLOSED') badgeClass = 'bg-danger';
                else if (status === 'PENDING') badgeClass = 'bg-warning';
                else if (status === 'WORKING') badgeClass = 'bg-info';
                else if (status === 'FILLED') badgeClass = 'bg-success';
                
                return `<span class="badge ${badgeClass}">${status}</span>`;
            }
        },
        {
            title: "Broker",
            field: "broker",
            headerFilter: true
        },
        {
            title: "Créé le",
            field: "created_at",
            headerFilter: false,
            sorter: "datetime"
        },
        {
            title: "Actions",
            headerSort: false,
            formatter: function(cell) {
                const row = cell.getRow();
                const data = row.getData();
                
                if (data.type === 'asset') {
                    return `<button class="btn btn-sm btn-info" onclick="showAssetDetails('${data.symbol}')">
                        <i class="fas fa-eye"></i> Détails
                    </button>`;
                }
                return '-';
            }
        }
    ],
    rowFormatter: function(row) {
        const data = row.getData();
        if (data.type === 'asset') {
            row.getElement().classList.add('asset-row');
        } else if (data.type === 'position') {
            row.getElement().classList.add('position-row');
        } else if (data.type === 'pending_order') {
            row.getElement().classList.add('pending-order-row');
        }
    },
    dataTree: true,
    dataTreeStartExpanded: false,
    dataTreeChildField: "children"
});

// Charger les données des positions et ordres
function loadPositionsData() {
    fetch('/positions/overview/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                positionsTable.setData(data.data);
                updatePositionsStats(data.data);
            } else {
                console.error('Erreur:', data.error);
                alert('Erreur lors du chargement des données: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors du chargement des données');
        });
}

// Mettre à jour les statistiques des positions
function updatePositionsStats(data) {
    const assets = data.filter(item => item.type === 'asset');
    const positions = data.filter(item => item.type === 'position');
    const pendingOrders = data.filter(item => item.type === 'pending_order');
    
    const totalPositions = positions.length;
    const totalPendingOrders = pendingOrders.length;
    const netExposure = assets.reduce((sum, asset) => sum + asset.net_position, 0);
    
    document.getElementById('total-assets-positions').textContent = assets.length;
    document.getElementById('total-positions-count').textContent = totalPositions;
    document.getElementById('total-pending-orders-count').textContent = totalPendingOrders;
    
    const netElement = document.getElementById('net-exposure-total');
    netElement.textContent = netExposure.toFixed(2);
    netElement.className = netExposure > 0 ? 'net-positive' : netExposure < 0 ? 'net-negative' : 'net-zero';
}

// Fonction pour afficher les détails d'un asset
window.showAssetDetails = function(symbol) {
    const assetData = positionsTable.getData().find(item => item.type === 'asset' && item.symbol === symbol);
    if (!assetData) return;

    const positions = assetData.children.filter(child => child.type === 'position');
    const pendingOrders = assetData.children.filter(child => child.type === 'pending_order');

    let detailsHtml = `
        <h6>${assetData.symbol} - ${assetData.name}</h6>
        <p><strong>Plateforme:</strong> ${assetData.platform}</p>
        <p><strong>Exposition nette:</strong> <span class="${assetData.net_position > 0 ? 'net-positive' : assetData.net_position < 0 ? 'net-negative' : 'net-zero'}">${assetData.net_position.toFixed(2)}</span></p>
        
        <h6 class="mt-3">Positions (${positions.length})</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Side</th>
                        <th>Taille</th>
                        <th>Prix entrée</th>
                        <th>Prix actuel</th>
                        <th>P&L</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
    `;

    positions.forEach(pos => {
        const pnlClass = pos.pnl > 0 ? 'net-positive' : pos.pnl < 0 ? 'net-negative' : 'net-zero';
        detailsHtml += `
            <tr>
                <td><span class="${pos.side === 'BUY' ? 'side-buy' : 'side-sell'}">${pos.side}</span></td>
                <td>${pos.size.toFixed(2)}</td>
                <td>${pos.entry_price.toFixed(4)}</td>
                <td>${pos.current_price.toFixed(4)}</td>
                <td class="${pnlClass}">${pos.pnl.toFixed(2)}</td>
                <td><span class="badge bg-success">${pos.status}</span></td>
            </tr>
        `;
    });

    detailsHtml += `
                </tbody>
            </table>
        </div>
        
        <h6 class="mt-3">Ordres en cours (${pendingOrders.length})</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Side</th>
                        <th>Quantité</th>
                        <th>Exécuté</th>
                        <th>Prix</th>
                        <th>Type</th>
                        <th>Statut</th>
                        <th>Broker</th>
                    </tr>
                </thead>
                <tbody>
    `;

    pendingOrders.forEach(order => {
        detailsHtml += `
            <tr>
                <td><span class="${order.side === 'BUY' ? 'side-buy' : 'side-sell'}">${order.side}</span></td>
                <td>${order.quantity.toFixed(2)}</td>
                <td>${order.executed_quantity.toFixed(2)}</td>
                <td>${order.price ? order.price.toFixed(4) : 'Market'}</td>
                <td>${order.order_type}</td>
                <td><span class="badge bg-warning">${order.status}</span></td>
                <td>${order.broker}</td>
            </tr>
        `;
    });

    detailsHtml += `
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('positionsDetailsModalBody').innerHTML = detailsHtml;
    new bootstrap.Modal(document.getElementById('positionsDetailsModal')).show();
};

// Fonction pour mettre à jour les quantités de portefeuille
function updatePortfolioQuantities() {
    // Afficher un indicateur de chargement
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mise à jour...';
    button.disabled = true;
    
    // Appeler l'API pour mettre à jour les quantités
    fetch('/strategies/update-portfolio/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Afficher un message de succès
            showAlert('success', `Portefeuille mis à jour avec succès ! ${data.updated_count} stratégies mises à jour.`);
            
            // Recharger la page pour afficher les nouvelles données
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            // Afficher un message d'erreur
            showAlert('danger', `Erreur lors de la mise à jour : ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showAlert('danger', 'Erreur lors de la mise à jour du portefeuille');
    })
    .finally(() => {
        // Restaurer le bouton
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Fonction pour afficher des alertes
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insérer l'alerte en haut de la page
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-fermer après 5 secondes
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Fonction pour récupérer le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Charger les données au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadPositionsData();
});
</script>
{% endblock %}