{% extends "base.html" %}
{% block title %}Trades - Tableau imbriqué{% endblock %}
{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="fas fa-chart-line"></i> Trades - Tableau imbriqué par symbole
    </h1>

    <!-- Filtres -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter"></i> Filtres
            </h5>
        </div>
        <div class="card-body">
            <form id="filtersForm" class="row g-3">
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Date début</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" 
                           value="{{ start_date|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">Date fin</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" 
                           value="{{ end_date|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label for="broker_filter" class="form-label">Broker</label>
                    <select class="form-select" id="broker_filter" name="broker_filter">
                        <option value="">Tous les brokers</option>
                        <option value="saxo" {% if broker_filter == 'saxo' %}selected{% endif %}>Saxo Bank</option>
                        <option value="binance" {% if broker_filter == 'binance' %}selected{% endif %}>Binance</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search"></i> Filtrer
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="resetFilters">
                        <i class="fas fa-undo"></i> Réinitialiser
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tableau des trades -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-table"></i> Trades groupés par symbole
            </h5>
        </div>
        <div class="card-body">
            <div id="trades-table"></div>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Total Symboles</h6>
                    <h4 id="totalSymbols">0</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Total Trades</h6>
                    <h4 id="totalTrades">0</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Volume Net Total</h6>
                    <h4 id="totalVolume">€0</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">P&L Total</h6>
                    <h4 id="totalPnL">€0</h4>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Données des trades depuis Django
    const tradesData = {{ trades_data|safe }};
    
    console.log('Données reçues:', tradesData);
    
    // Préparer les données pour affichage (groupes + trades individuels)
    const allData = [];
    
    tradesData.forEach(group => {
        // Ajouter la ligne de groupe
        allData.push({
            ...group,
            is_group: true,
            display_symbol: group.symbol,
            display_trades: group.trade_count,
            display_volume: group.net_volume,
            display_quantity: group.net_quantity,
            display_pnl: group.pnl,
            display_last_trade: group.last_trade,
            display_platforms: group.platforms
        });
        
        // Ajouter tous les trades individuels
        if (group.children) {
            group.children.forEach(trade => {
                allData.push({
                    ...trade,
                    is_group: false,
                    display_symbol: `  ${trade.symbol}`,
                    display_trades: '-',
                    display_volume: trade.volume,
                    display_quantity: trade.size,
                    display_pnl: '-',
                    display_last_trade: trade.timestamp,
                    display_platforms: trade.platform
                });
            });
        }
    });
    
    console.log('Données complètes:', allData);
    
    // Configuration du tableau Tabulator avec toutes les données
    const table = new Tabulator("#trades-table", {
        data: allData,
        layout: "fitDataFill",
        pagination: true,
        paginationSize: 50,
        paginationSizeSelector: [20, 50, 100, 200],
        columns: [
            // Symbole
            {
                title: "Symbole",
                field: "display_symbol",
                headerFilter: "input",
                headerFilterPlaceholder: "Rechercher...",
                width: 150,
                formatter: function(cell) {
                    const row = cell.getRow();
                    const data = row.getData();
                    if (data.is_group) {
                        return `<strong class="text-primary">${cell.getValue()}</strong>`;
                    } else {
                        return `<span class="text-muted">${cell.getValue()}</span>`;
                    }
                }
            },
            // Nombre de trades
            {
                title: "Trades",
                field: "display_trades",
                headerSort: true,
                width: 80,
                formatter: function(cell) {
                    const row = cell.getRow();
                    const data = row.getData();
                    if (data.is_group) {
                        return `<span class="badge bg-primary">${cell.getValue()}</span>`;
                    } else {
                        return '-';
                    }
                }
            },
            // Volume
            {
                title: "Volume",
                field: "display_volume",
                headerSort: true,
                width: 120,
                formatter: function(cell) {
                    const value = cell.getValue();
                    if (value === '-') return '-';
                    const color = value >= 0 ? 'success' : 'danger';
                    const sign = value >= 0 ? '+' : '';
                    return `<span class="text-${color}">${sign}€${Math.abs(value).toFixed(2)}</span>`;
                }
            },
            // Quantité
            {
                title: "Quantité",
                field: "display_quantity",
                headerSort: true,
                width: 120,
                formatter: function(cell) {
                    const value = cell.getValue();
                    if (value === '-') return '-';
                    const color = value >= 0 ? 'success' : 'danger';
                    const sign = value >= 0 ? '+' : '';
                    return `<span class="text-${color}">${sign}${Math.abs(value).toFixed(4)}</span>`;
                }
            },
            // P&L
            {
                title: "P&L",
                field: "display_pnl",
                headerSort: true,
                width: 100,
                formatter: function(cell) {
                    const value = cell.getValue();
                    if (value === '-') return '-';
                    const color = value >= 0 ? 'success' : 'danger';
                    const sign = value >= 0 ? '+' : '';
                    return `<span class="text-${color}">${sign}€${Math.abs(value).toFixed(2)}</span>`;
                }
            },
            // Dernier trade
            {
                title: "Timestamp",
                field: "display_last_trade",
                headerSort: true,
                width: 150,
                formatter: function(cell) {
                    const value = cell.getValue();
                    if (!value || value === '-') return '-';
                    return new Date(value).toLocaleString('fr-FR');
                }
            },
            // Plateformes
            {
                title: "Plateforme",
                field: "display_platforms",
                width: 120,
                formatter: function(cell) {
                    const value = cell.getValue();
                    if (!value) return '-';
                    if (typeof value === 'string' && value.includes(',')) {
                        // Groupe avec plusieurs plateformes
                        const platforms = value.split(', ');
                        return platforms.map(p => `<span class="badge bg-secondary me-1">${p}</span>`).join('');
                    } else {
                        // Trade individuel
                        return `<span class="badge bg-info">${value}</span>`;
                    }
                }
            },
            // Side (pour les trades individuels)
            {
                title: "Side",
                field: "side",
                width: 80,
                formatter: function(cell) {
                    const row = cell.getRow();
                    const data = row.getData();
                    if (data.is_group) {
                        return '-';
                    } else {
                        const side = cell.getValue();
                        const color = side === 'BUY' ? 'success' : 'danger';
                        return `<span class="badge bg-${color}">${side}</span>`;
                    }
                }
            },
            // Prix (pour les trades individuels)
            {
                title: "Prix",
                field: "price",
                width: 100,
                formatter: function(cell) {
                    const row = cell.getRow();
                    const data = row.getData();
                    if (data.is_group) {
                        return '-';
                    } else {
                        const price = cell.getValue();
                        return price ? `€${price}` : '-';
                    }
                }
            }
        ],
        // Style des lignes
        rowFormatter: function(row) {
            const data = row.getData();
            if (data.is_group) {
                row.getElement().style.backgroundColor = "#e3f2fd";
                row.getElement().style.fontWeight = "bold";
                row.getElement().style.borderTop = "2px solid #2196f3";
            } else {
                row.getElement().style.backgroundColor = "#fafafa";
                row.getElement().style.fontWeight = "normal";
            }
        }
    });
    
    // Mise à jour des statistiques
    function updateStats() {
        const data = table.getData();
        let totalSymbols = 0;
        let totalTrades = 0;
        let totalVolume = 0;
        let totalPnL = 0;

        data.forEach(row => {
            if (row.is_group) {
                totalSymbols++;
                totalTrades += row.trade_count;
                totalVolume += Math.abs(row.net_volume);
                totalPnL += row.pnl;
            }
        });

        document.getElementById('totalSymbols').textContent = totalSymbols;
        document.getElementById('totalTrades').textContent = totalTrades;
        document.getElementById('totalVolume').textContent = `€${totalVolume.toFixed(2)}`;
        document.getElementById('totalPnL').textContent = `€${totalPnL.toFixed(2)}`;
    }

    // Gestion des filtres
    document.getElementById('filtersForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const params = new URLSearchParams();
        
        for (let [key, value] of formData.entries()) {
            if (value) params.append(key, value);
        }
        
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    });

    // Réinitialisation des filtres
    document.getElementById('resetFilters').addEventListener('click', function() {
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
        document.getElementById('broker_filter').value = '';
        window.location.href = window.location.pathname;
    });

    // Mettre à jour les stats après chargement
    table.on("dataLoaded", updateStats);
    table.on("dataFiltered", updateStats);
});
</script>

<style>
.badge {
    font-size: 0.75em;
}
</style>
{% endblock %}