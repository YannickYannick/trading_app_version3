{% extends "base.html" %}
{% block title %}Trades Tabulator{% endblock %}
{% block content %}
<h1>Trades - Tableau dynamique</h1>

<!-- Bouton pour configurer les colonnes -->
<div class="mb-3">
    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#columnSelectorModal">
        <i class="fas fa-cog"></i> Configurer les colonnes
    </button>
    
    <!-- Boutons pour modes Binance -->
    <div class="btn-group ms-2" role="group">
        <button type="button" class="btn btn-outline-primary" id="binanceAuto">
            <i class="fas fa-magic"></i> Binance Auto
        </button>
        <button type="button" class="btn btn-outline-success" id="binancePredefined">
            <i class="fas fa-list"></i> Binance Pr√©d√©fini
        </button>
        <button type="button" class="btn btn-outline-warning" id="binanceAll">
            <i class="fas fa-database"></i> Binance Tout
        </button>
    </div>
    
    <!-- Boutons pour synchronisation Saxo -->
    {% if saxo_brokers %}
    <div class="btn-group ms-2" role="group">
        <span class="btn btn-outline-info disabled">
            <i class="fas fa-university"></i> Saxo Trades
        </span>
        {% for broker in saxo_brokers %}
        <button type="button" class="btn btn-outline-info saxo-sync-btn" data-broker-id="{{ broker.id }}" data-broker-name="{{ broker.name }}">
            <i class="fas fa-sync"></i> {{ broker.name }}
        </button>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Boutons pour gestion globale des trades -->
    <div class="btn-group ms-2" role="group">
        <span class="btn btn-outline-warning disabled">
            <i class="fas fa-cogs"></i> Gestion Globale
        </span>
        <button type="button" class="btn btn-outline-warning" id="updateAllTrades">
            <i class="fas fa-sync-alt"></i> Mettre √† jour tous les trades
        </button>
        <button type="button" class="btn btn-outline-danger" id="deleteAllTrades">
            <i class="fas fa-trash"></i> Supprimer tous les trades
        </button>
    </div>
</div>

<div id="trade-table"></div>

<!-- Section Graphique des Trades -->
<div class="mt-4">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line"></i> Graphique des Trades par Instrument
            </h5>
        </div>
        <div class="card-body">
            <!-- S√©lecteur d'instrument -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="instrumentSelector" class="form-label">S√©lectionner un instrument :</label>
                    <select class="form-select" id="instrumentSelector">
                        <option value="">Choisir un instrument...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="periodSelector" class="form-label">P√©riode :</label>
                    <select class="form-select" id="periodSelector">
                        <option value="all">Tous les trades</option>
                        <option value="30">30 derniers jours</option>
                        <option value="7">7 derniers jours</option>
                        <option value="1">Derni√®res 24h</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="chartTypeSelector" class="form-label">Type de graphique :</label>
                    <select class="form-select" id="chartTypeSelector">
                        <option value="candlestick">Chandeliers</option>
                        <option value="line">Ligne</option>
                    </select>
                </div>
            </div>
            
            <!-- Statistiques -->
            <div class="row mb-3" id="tradeStats" style="display: none;">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">Total Trades</h6>
                            <h4 id="totalTrades">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">P&L Total</h6>
                            <h4 id="totalPnL">0.00</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">Volume Total</h6>
                            <h4 id="totalVolume">0.00</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">Prix Moyen</h6>
                            <h4 id="avgPrice">0.00</h4>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Conteneur du graphique -->
            <div id="tradingChart" style="height: 500px; width: 100%;"></div>
        </div>
    </div>
</div>

<!-- Modal pour s√©lectionner les colonnes -->
<div class="modal fade" id="columnSelectorModal" tabindex="-1" aria-labelledby="columnSelectorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnSelectorModalLabel">
                    <i class="fas fa-columns"></i> S√©lectionner les colonnes √† afficher
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Colonnes disponibles :</h6>
                        <div id="availableColumns" class="border p-3" style="height: 300px; overflow-y: auto;">
                            <!-- Les colonnes disponibles seront ajout√©es ici dynamiquement -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Colonnes affich√©es :</h6>
                        <div id="selectedColumns" class="border p-3" style="height: 300px; overflow-y: auto;">
                            <!-- Les colonnes s√©lectionn√©es seront ajout√©es ici dynamiquement -->
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <button type="button" class="btn btn-primary" id="applyColumns">
                            <i class="fas fa-check"></i> Appliquer
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetColumns">
                            <i class="fas fa-undo"></i> R√©initialiser
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.3/css/tabulator.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.3/js/tabulator.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- TradingView Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script>
    var tabledata = JSON.parse('{{ data_trades|default:"[]"|escapejs }}');
    var chart = null;
    var candlestickSeries = null;
    var lineSeries = null;
    var tradeMarkers = [];
    
    // D√©finition de toutes les colonnes disponibles
    var allColumns = [
        { title: "Broker", field: "broker_name", headerFilter: "input" },
        { title: "Environnement", field: "environment", headerFilter: "select", headerFilterParams: { values: ["live", "simulation"] } },
        { title: "Instrument", field: "symbol", headerFilter: "input" },
        { title: "Type", field: "type", headerFilter: "input" },
        { title: "Direction", field: "direction", headerFilter: "select", headerFilterParams: { values: ["Long", "Short"] } },
        { title: "Taille", field: "size", headerFilter: "input" },
        { title: "Prix d'ouverture", field: "opening_price", headerFilter: "input", formatter: function(cell) {
            var value = cell.getValue();
            if (value && !isNaN(value)) {
                return parseFloat(value).toFixed(2);
            }
            return value;
        }},
        { title: "Prix de cl√¥ture", field: "closing_price", headerFilter: "input", formatter: function(cell) {
            var value = cell.getValue();
            if (value && !isNaN(value)) {
                return parseFloat(value).toFixed(2);
            }
            return value;
        }},
        { title: "P&L", field: "profit_loss", headerFilter: "input", formatter: function(cell) {
            var value = cell.getValue();
            if (value && !isNaN(value)) {
                value = parseFloat(value);
                if (value > 0) {
                    cell.getElement().style.color = "green";
                } else if (value < 0) {
                    cell.getElement().style.color = "red";
                }
                return value.toFixed(2);
            }
            return value;
        }},
        { title: "Ratio P&L", field: "profit_loss_ratio", headerFilter: "input", formatter: function(cell) {
            var value = cell.getValue();
            if (value && !isNaN(value)) {
                value = parseFloat(value) * 100;
                if (value > 0) {
                    cell.getElement().style.color = "green";
                } else if (value < 0) {
                    cell.getElement().style.color = "red";
                }
                return value.toFixed(2) + "%";
            }
            return value;
        }},
        { title: "Date ouverture", field: "opening_date", headerFilter: "input" },
        { title: "Date cl√¥ture", field: "timestamp", headerFilter: "input" }
    ];
    
    // Colonnes par d√©faut (les plus importantes)
    var defaultColumns = ["broker_name", "symbol", "direction", "size", "profit_loss", "timestamp"];
    
    // Fonction pour sauvegarder les colonnes s√©lectionn√©es
    function saveSelectedColumns(columns) {
        localStorage.setItem('trade_tabulator_selected_columns', JSON.stringify(columns));
    }
    
    // Fonction pour charger les colonnes s√©lectionn√©es
    function loadSelectedColumns() {
        var saved = localStorage.getItem('trade_tabulator_selected_columns');
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                console.log('Erreur lors du chargement des colonnes sauvegard√©es:', e);
            }
        }
        return [...defaultColumns];
    }
    
    // Colonnes actuellement s√©lectionn√©es (charg√©es depuis localStorage)
    var selectedColumns = loadSelectedColumns();
    
    // Fonction pour obtenir les colonnes √† afficher
    function getVisibleColumns() {
        return allColumns.filter(col => selectedColumns.includes(col.field));
    }
    
    // Fonction pour initialiser le s√©lecteur de colonnes
    function initColumnSelector() {
        const availableDiv = document.getElementById('availableColumns');
        const selectedDiv = document.getElementById('selectedColumns');
        
        // Vider les conteneurs
        availableDiv.innerHTML = '';
        selectedDiv.innerHTML = '';
        
        // Ajouter toutes les colonnes disponibles
        allColumns.forEach(col => {
            const isSelected = selectedColumns.includes(col.field);
            const container = isSelected ? selectedDiv : availableDiv;
            
            const columnItem = document.createElement('div');
            columnItem.className = 'column-item mb-2 p-2 border rounded cursor-pointer';
            columnItem.style.cursor = 'pointer';
            columnItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>${col.title}</span>
                    <i class="fas fa-${isSelected ? 'minus' : 'plus'} text-${isSelected ? 'danger' : 'success'}"></i>
                </div>
            `;
            
            columnItem.addEventListener('click', function() {
                if (isSelected) {
                    // Retirer de la s√©lection
                    selectedColumns = selectedColumns.filter(field => field !== col.field);
                } else {
                    // Ajouter √† la s√©lection
                    selectedColumns.push(col.field);
                }
                initColumnSelector();
            });
            
            container.appendChild(columnItem);
        });
    }
    
    // Cr√©er la table avec les colonnes charg√©es
    var table = new Tabulator("#trade-table", {
        height: "400px",
        layout: "fitDataFill",
        reactiveData: true,
        data: tabledata,
        columns: getVisibleColumns()
    });
    
    // Initialiser le s√©lecteur de colonnes apr√®s la cr√©ation de la table
    initColumnSelector();
    
    // Appliquer les changements de colonnes
    document.getElementById('applyColumns').addEventListener('click', function() {
        table.setColumns(getVisibleColumns());
        saveSelectedColumns(selectedColumns);
        $('#columnSelectorModal').modal('hide');
        // Forcer le redessinage de la table
        table.redraw(true);
    });
    
    // R√©initialiser les colonnes
    document.getElementById('resetColumns').addEventListener('click', function() {
        selectedColumns = [...defaultColumns];
        saveSelectedColumns(selectedColumns);
        table.setColumns(getVisibleColumns());
        initColumnSelector();
        // Forcer le redessinage de la table
        table.redraw(true);
    });
    
    // R√©initialiser le s√©lecteur quand le modal s'ouvre
    $('#columnSelectorModal').on('show.bs.modal', function () {
        initColumnSelector();
    });
    
    // Initialiser le s√©lecteur d'instruments
    function initInstrumentSelector() {
        const selector = document.getElementById('instrumentSelector');
        const instruments = [...new Set(tabledata.map(trade => trade.symbol).filter(symbol => symbol && symbol !== 'N/A'))];
        
        instruments.forEach(instrument => {
            const option = document.createElement('option');
            option.value = instrument;
            option.textContent = instrument;
            selector.appendChild(option);
        });
    }
    
    // Initialiser le graphique TradingView
    function initChart() {
        const chartContainer = document.getElementById('tradingChart');
        
        if (chart) {
            chart.remove();
        }
        
        chart = LightweightCharts.createChart(chartContainer, {
            width: chartContainer.clientWidth,
            height: chartContainer.clientHeight,
            layout: {
                backgroundColor: '#ffffff',
                textColor: '#333',
            },
            grid: {
                vertLines: {
                    color: '#f0f0f0',
                },
                horzLines: {
                    color: '#f0f0f0',
                },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#cccccc',
            },
            timeScale: {
                borderColor: '#cccccc',
                timeVisible: true,
                secondsVisible: false,
            },
        });
        
        // Cr√©er les s√©ries
        candlestickSeries = chart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderVisible: false,
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350',
        });
        
        lineSeries = chart.addLineSeries({
            color: '#2196F3',
            lineWidth: 2,
        });
        
        // G√©rer le redimensionnement
        window.addEventListener('resize', () => {
            chart.applyOptions({
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
            });
        });
    }
    
    // Charger les donn√©es de prix pour un instrument
    function loadPriceData(symbol) {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: `/trades/chart-data/${encodeURIComponent(symbol)}/`,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        resolve(response.data);
                    } else {
                        console.warn('Donn√©es de prix non disponibles, utilisation de donn√©es simul√©es');
                        // Fallback vers des donn√©es simul√©es
                        resolve(generateSimulatedData(symbol));
                    }
                },
                error: function(xhr) {
                    console.warn('Erreur r√©cup√©ration donn√©es prix, utilisation de donn√©es simul√©es');
                    // Fallback vers des donn√©es simul√©es
                    resolve(generateSimulatedData(symbol));
                }
            });
        });
    }
    
    // G√©n√©rer des donn√©es simul√©es en cas d'erreur
    function generateSimulatedData(symbol) {
        const now = new Date();
        const data = [];
        
        for (let i = 30; i >= 0; i--) {
            const time = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
            const basePrice = 100 + Math.random() * 50;
            const open = basePrice;
            const high = basePrice + Math.random() * 10;
            const low = basePrice - Math.random() * 10;
            const close = basePrice + (Math.random() - 0.5) * 10;
            
            data.push({
                time: Math.floor(time.getTime() / 1000),
                open: open,
                high: high,
                low: low,
                close: close,
            });
        }
        
        return data;
    }
    
    // Afficher les trades sur le graphique
    async function displayTradesOnChart(symbol, period) {
        if (!chart) return;
        
        // Filtrer les trades pour cet instrument et cette p√©riode
        let filteredTrades = tabledata.filter(trade => trade.symbol === symbol);
        
        if (period !== 'all') {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(period));
            filteredTrades = filteredTrades.filter(trade => {
                const tradeDate = new Date(trade.timestamp);
                return tradeDate >= cutoffDate;
            });
        }
        
        // Charger les donn√©es de prix
        const priceData = await loadPriceData(symbol);
        
        // Afficher les donn√©es selon le type de graphique
        const chartType = document.getElementById('chartTypeSelector').value;
        
        if (chartType === 'candlestick') {
            candlestickSeries.setData(priceData);
            lineSeries.setData([]);
        } else {
            const lineData = priceData.map(candle => ({
                time: candle.time,
                value: candle.close,
            }));
            lineSeries.setData(lineData);
            candlestickSeries.setData([]);
        }
        
        // Ajouter les marqueurs de trades
        clearTradeMarkers();
        
        filteredTrades.forEach(trade => {
            const tradeTime = Math.floor(new Date(trade.timestamp).getTime() / 1000);
            const price = parseFloat(trade.opening_price);
            
            // Trouver le point le plus proche dans les donn√©es de prix
            const closestPrice = priceData.reduce((prev, curr) => {
                return Math.abs(curr.time - tradeTime) < Math.abs(prev.time - tradeTime) ? curr : prev;
            });
            
            const marker = chart.addCandlestickSeries({
                lastValueVisible: false,
                priceLineVisible: false,
            });
            
            const markerData = [{
                time: closestPrice.time,
                open: price,
                high: price,
                low: price,
                close: price,
            }];
            
            marker.setData(markerData);
            
            // Ajouter une annotation
            const color = trade.direction === 'BUY' ? '#26a69a' : '#ef5350';
            const shape = trade.direction === 'BUY' ? 'arrowUp' : 'arrowDown';
            
            chart.addCandlestickSeries({
                lastValueVisible: false,
                priceLineVisible: false,
                upColor: color,
                downColor: color,
            }).setData([{
                time: closestPrice.time,
                open: price,
                high: price + 2,
                low: price - 2,
                close: price,
            }]);
            
            tradeMarkers.push(marker);
        });
        
        // Calculer et afficher les statistiques
        calculateAndDisplayStats(filteredTrades);
        
        // Afficher les statistiques
        document.getElementById('tradeStats').style.display = 'block';
    }
    
    // Effacer les marqueurs de trades
    function clearTradeMarkers() {
        tradeMarkers.forEach(marker => {
            chart.removeSeries(marker);
        });
        tradeMarkers = [];
    }
    
    // Calculer et afficher les statistiques
    function calculateAndDisplayStats(trades) {
        const totalTrades = trades.length;
        const totalPnL = trades.reduce((sum, trade) => sum + (parseFloat(trade.profit_loss) || 0), 0);
        const totalVolume = trades.reduce((sum, trade) => sum + (parseFloat(trade.size) || 0), 0);
        const avgPrice = trades.reduce((sum, trade) => sum + (parseFloat(trade.opening_price) || 0), 0) / totalTrades;
        
        document.getElementById('totalTrades').textContent = totalTrades;
        document.getElementById('totalPnL').textContent = totalPnL.toFixed(2);
        document.getElementById('totalPnL').style.color = totalPnL >= 0 ? 'green' : 'red';
        document.getElementById('totalVolume').textContent = totalVolume.toFixed(2);
        document.getElementById('avgPrice').textContent = avgPrice.toFixed(2);
    }
    
    // √âv√©nements pour le graphique
    document.getElementById('instrumentSelector').addEventListener('change', async function() {
        const symbol = this.value;
        const period = document.getElementById('periodSelector').value;
        
        if (symbol) {
            await displayTradesOnChart(symbol, period);
        } else {
            // Effacer le graphique
            if (chart) {
                candlestickSeries.setData([]);
                lineSeries.setData([]);
                clearTradeMarkers();
                document.getElementById('tradeStats').style.display = 'none';
            }
        }
    });
    
    document.getElementById('periodSelector').addEventListener('change', async function() {
        const symbol = document.getElementById('instrumentSelector').value;
        const period = this.value;
        
        if (symbol) {
            await displayTradesOnChart(symbol, period);
        }
    });
    
    document.getElementById('chartTypeSelector').addEventListener('change', async function() {
        const symbol = document.getElementById('instrumentSelector').value;
        const period = document.getElementById('periodSelector').value;
        
        if (symbol) {
            await displayTradesOnChart(symbol, period);
        }
    });
    
    // Initialiser le graphique et le s√©lecteur d'instruments
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        initInstrumentSelector();
    });
    
    function buttonFormatter(cell) {
        var button = document.createElement("button");
        button.textContent = "Save !";
        button.addEventListener("click", function() {
            var rowData = cell.getRow().getData();
            const csrftoken = getCookie('csrftoken');
            $.ajax({
                url: '/trades/save/',
                type: 'POST',
                data: rowData,
                headers: {'X-CSRFToken': csrftoken },
                success: function(response) {
                    alert("Enregistr√© !");
                },
                error: function(xhr) {
                    console.log("Erreur lors de l'enregistrement :", xhr.responseText);
                    alert("Erreur lors de l'enregistrement !\n" + xhr.responseText);
                }
            });
        });
        return button;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Gestion des boutons Binance
    document.getElementById("binanceAuto").addEventListener("click", function(){
        loadBinanceTrades("auto");
    });
    
    document.getElementById("binancePredefined").addEventListener("click", function(){
        loadBinanceTrades("predefined");
    });
    
    document.getElementById("binanceAll").addEventListener("click", function(){
        loadBinanceTrades("all");
    });
    
    // Gestion des boutons de gestion globale
    document.getElementById("updateAllTrades").addEventListener("click", function(){
        if (confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir mettre √† jour tous les trades de tous les brokers ?")) {
            updateAllTrades();
        }
    });
    
    document.getElementById("deleteAllTrades").addEventListener("click", function(){
        if (confirm("üö® ATTENTION ! √ätes-vous absolument s√ªr de vouloir supprimer TOUS les trades ? Cette action est irr√©versible !")) {
            deleteAllTrades();
        }
    });
    
    // Gestion des boutons Saxo
    document.querySelectorAll('.saxo-sync-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const brokerId = this.getAttribute('data-broker-id');
            const brokerName = this.getAttribute('data-broker-name');
            syncSaxoTrades(brokerId, brokerName);
        });
    });
    
    function syncSaxoTrades(brokerId, brokerName) {
        const csrftoken = getCookie('csrftoken');
        
        // Afficher un indicateur de chargement
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sync...';
        button.disabled = true;
        
        $.ajax({
            url: `/brokers/${brokerId}/sync-trades/`,
            type: 'POST',
            headers: {'X-CSRFToken': csrftoken },
            success: function(response) {
                if (response.success) {
                    // Recharger les donn√©es de la table
                    location.reload();
                    
                    if (response.saved_count > 0) {
                        alert(`‚úÖ ${response.saved_count} nouveaux trades Saxo (${brokerName}) synchronis√©s !\nüìä ${response.total_trades} trades au total.`);
                    } else {
                        alert(`‚ÑπÔ∏è Aucun nouveau trade trouv√© pour Saxo (${brokerName}).\nüìä ${response.total_trades} trades au total.`);
                    }
                } else {
                    alert("‚ùå Erreur lors de la synchronisation des trades Saxo: " + response.error);
                }
            },
            error: function(xhr) {
                console.error("Erreur AJAX:", xhr);
                alert("‚ùå Erreur lors de la synchronisation des trades Saxo");
            },
            complete: function() {
                // Restaurer le bouton
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    }
    
    function updateAllTrades() {
        const csrftoken = getCookie('csrftoken');
        
        // Afficher un indicateur de chargement
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mise √† jour...';
        button.disabled = true;
        
        $.ajax({
            url: '/trades/update-all/',
            type: 'POST',
            headers: {'X-CSRFToken': csrftoken },
            success: function(response) {
                if (response.success) {
                    // Recharger les donn√©es de la table
                    location.reload();
                    
                    let details = response.details.join('\n');
                    alert(`‚úÖ ${response.updated_count} trades mis √† jour au total !\n\nD√©tails par broker:\n${details}`);
                } else {
                    alert("‚ùå Erreur lors de la mise √† jour des trades: " + response.error);
                }
            },
            error: function(xhr) {
                console.error("Erreur AJAX:", xhr);
                alert("‚ùå Erreur lors de la mise √† jour des trades");
            },
            complete: function() {
                // Restaurer le bouton
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    }
    
    function deleteAllTrades() {
        const csrftoken = getCookie('csrftoken');
        
        // Afficher un indicateur de chargement
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suppression...';
        button.disabled = true;
        
        $.ajax({
            url: '/trades/delete-all/',
            type: 'POST',
            headers: {'X-CSRFToken': csrftoken },
            success: function(response) {
                if (response.success) {
                    // Recharger les donn√©es de la table
                    location.reload();
                    
                    alert(`‚úÖ ${response.deleted_count} trades supprim√©s avec succ√®s !`);
                } else {
                    alert("‚ùå Erreur lors de la suppression des trades: " + response.error);
                }
            },
            error: function(xhr) {
                console.error("Erreur AJAX:", xhr);
                alert("‚ùå Erreur lors de la suppression des trades");
            },
            complete: function() {
                // Restaurer le bouton
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    }
    
    function loadBinanceTrades(mode) {
        const csrftoken = getCookie('csrftoken');
        
        // Afficher un indicateur de chargement
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
        button.disabled = true;
        
        $.ajax({
            url: '/trades/binance/',
            type: 'POST',
            data: JSON.stringify({ mode: mode }),
            contentType: 'application/json',
            headers: {'X-CSRFToken': csrftoken },
            success: function(response) {
                if (response.success) {
                    // Remplacer les donn√©es de la table
                    tabledata = response.trades;
                    table.replaceData(tabledata);
                    
                    // Mettre √† jour le s√©lecteur d'instruments
                    initInstrumentSelector();
                    
                    if (response.saved_count > 0) {
                        alert(`‚úÖ ${response.saved_count} nouveaux trades Binance (${mode}) ajout√©s !\nüìä ${response.trades.length} trades affich√©s au total.\n\n${response.message}`);
                    } else {
                        alert(`‚ÑπÔ∏è Aucun nouveau trade trouv√© pour Binance (${mode}).\nüìä ${response.trades.length} trades affich√©s au total.`);
                    }
                } else {
                    alert("‚ùå Erreur lors du chargement des trades Binance: " + response.error);
                }
            },
            error: function(xhr) {
                console.error("Erreur AJAX:", xhr);
                alert("‚ùå Erreur lors du chargement des trades Binance");
            },
            complete: function() {
                // Restaurer le bouton
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    }
</script>

<style>
.column-item:hover {
    background-color: #f8f9fa;
}
.cursor-pointer {
    cursor: pointer;
}
</style>
{% endblock %}